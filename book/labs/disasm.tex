\chapter{Отладка %ассемблерного 
кода}

\setlablabel{disasm}

\purpose{научиться использовать инструменты отладки современных IDE; исследовать генерируемый компилятором код.}


\begin{tasks}

\item 
\labellocal{task:dev:int}
Разработайте программу на языке C++, вычисляющую три целых выражения от целого аргумента (в~соответствии с~вариантом).

\begin{tasks}

\item \strut
\labellocal{task:dev:int:a}

\begin{variants}[a]

$y(x) = x + 17$
\next

$y(x) = x \cdot 13$
\next

$y(x) = x - 21$
\next

$y(x) = x/11$
\next

\nextyearchange{$y(x) = x \Mod 7$}{$y(x) = x \cdot 7$}
\next

$y(x) = x/3$
\next

$y(x) = x^2$
\end{variants}
\item \strut
\labellocal{task:dev:int:b}

\begin{variants}[b]

$y(x) = x \cdot 2$
\next

$y(x) = - x - 1$
\next

$y(x) = x \cdot 3$
\next

$y(x) = |x|$
\next

$y(x) = x \cdot 5$
\next

$y(x) = x/2$
\next

$y(x) = x \Mod 4$
\next

$y(x) = x^2$
\end{variants}

\item \strut

\begin{variants}[ifelse]

$y(x) = \left\{\begin{array}{ll}
13,& x \geqslant 0 \\
7, & x < 0 \\
\end{array}\right.$
\next

$y(x) = \left\{\begin{array}{ll}
0, & x < 7 \\
x, & x \geqslant 7 \\
\end{array}\right.$
\next

$y(x) = \left\{\begin{array}{ll}
x, & x > 13\\
-1 ,& x \leqslant 13\\
\end{array}\right.$

\end{variants}

\end{tasks}


\descrcomment{Не обязательно вводить $x$ с~клавиатуры. Инициализация локальной переменной «узнаваемым» литералом упростит поиск её адреса.

\nextyearchange{}{

Сборка всех заданий данной лабораторной работы выполняется одним компилятором при одних и~тех же настройках.

Не все изменения кода на C++ приведут к~видимым изменениям дизассемблированного кода.
}
}

% {
% \small
% 
% Если разбить вычисление выражения на несколько простых действий, в~частности
% \begin{lstlisting}[style=lstsmall]
% int y, dy, x = 0x123;
% // y = x*5 - x*25 + x*125;
% y = x*5;
% dy = x*25;
% y -= dy;
% dy = x*125;
% y += dy;
% \end{lstlisting}
% будет легче идентифицировать вычисление каждого из них.
% При этом в~коде появится большее количество присваиваний (mov); если оптимизатор при расчёте выражения одним оператором заменял несколько действий одной командой (например, $-x-1$ на битовую инверсию) ассемблерный код вычислений может измениться, но при этом также будет соответствовать исходному выражению.
% 
% }

\item Запустите программу и,~используя инструменты отладчика (в~частности, дизассемблер), изучите ассемблерный код%.
, соответствующий вычислениям (для Code::Blocks "--- переключитесь на синтаксис AT\&T и~включите Mixed mode, чтобы в~окне дизассемблера перед каждой группой команд, соответствующих одному оператору языка высокого уровня, явно отображался этот оператор).

Занесите ассемблерный код, соответствующий вычислению $y(x)$, в~отчёт.
% , подробно прокомментировав мнемонику и~операнды для каждой команды.
Определите и прокомментируйте:
\begin{itemize}
\item обращение к~переменным $x$ и~$y$;
\item арифметические и~логические операции "--- сложение, вычитание, умножение, деление с~остатком, деление на $2^n$ и~т.\,д. (по возможности);
\item сравнения и~передачу управления в~ветвлениях.
\end{itemize}


% \item В~программе из задания \reflocal{task:dev:int} дополнительно примените к~используемым переменным модификатор volatile (или добавьте новый  фрагмент кода с~аналогичными вычислениями).
% Опишите в~отчёте, как изменился ассемблерный код.
% 
% \item В~программе из задания \reflocal{task:dev:int} дополнительно примените к~используемым переменным спецификатор register.
% Опишите в~отчёте, как изменился ассемблерный код.
% 
% 
% \item В~программе из задания \reflocal{task:dev:int} сделайте переменные глобальными.
% Опишите в~отчёте, как изменился ассемблерный код.
% 
% 
% \item
% Замените тип int на char, short, long и long long.
% Опишите в~отчёте изменения кода для каждого типа.
% 
% 
% \item
% Замените тип переменных на double, single, long double.
% Опишите в~отчёте изменения кода для каждого типа.

\item Внесите в~программу из задания \reflocal{task:dev:int} изменения (либо, что предпочтительнее, добавьте новые  фрагменты кода, выполняющие аналогичные вычисления для других переменных, используя макросы препроцессора или шаблоны C++).

\begin{itemize}
\item примените к~используемым переменным модификатор volatile;
\item  примените к~используемым переменным спецификатор register;
\item сделайте переменные глобальными;
\item измените тип с~int на char, short, long и long long;
\item измените тип с~int на  на double, float, long double% (деление (\lstinline!/!) "--- вещественное, для расчёта остатка (\lstinline!%!) усекайте вещественные переменные до int)
.
\end{itemize}
Опишите в~отчёте различия в ассемблерном коде.
% Объясните эти различия.

% Измените тип переменных с~int на double, single, long double и~рассчитайте
% \begin{variants}[vardouble]
% 
% $y(x) = 
% x + 2\cdot(x/3)$
% \next
% 
% $y(x) = 
% x + x/2 +x /4 + x/8$
% \next
% 
% $y(x) =  x^3 - (x-1)\cdot(x+1)$
% \next
% 
% $y(x) =  x^2+x+1$
% \next
% 
% $y(x) = 1 + x/3$
% \next
% 
% $y(x) =  2x\cdot(x-1)$
% \next
% 
% $y(x) =  x/2+3x+1$
% \end{variants}
% Как изменилось обращение к~переменным?

\item
Оформите вычисления из задания  \reflocal{task:dev:int}, \reflocal{task:dev:int:a} как целую функцию от целого аргумента.
Опишите в~отчёте код вызова функции.
Как передаётся аргумент?
Как возвращается значение?

\item
Измените тип аргумента и~результата на вещественный.
Опишите в~отчёте код вызова функции.
Как передаётся аргумент?
Как возвращается значение?

\item\bonus{+2 балла} 
Увеличьте количество аргументов до четырёх.
Как передаются аргументы?


\item\bonus{+2 балла} 
Используйте в~функции статическую переменную.
Как выглядит обращение к~ней?


% \item\termin{Бонус (+2 балла за платформу):} 
% Вызовите функцию из стандартной библиотеки C и~какой-либо метод/функцию из стандартной библиотеки C++.
% Сравните вызовы библиотечных функций C и~C++ друг с~другом, а~также с~вызовом функции, описанной внутри проекта.


\item \termin{Бонус (+2 балла за платформу):}  запустите тестовую программу (программы), используя платформу и/или компилятор, отличные от \stdOs{} и~\stdCompiler{}.  Результаты с~пояснениями внести в~конспект.
\end{tasks}


% 
% \section{Требования}
% 
% \begin{enumerate}
% \item Программы должны собираться на любой платформе (недопустимо использование платформозависимых элементов).
% % 
% Для разработки программ на языке C++ могут быть использованы кроссплатформенные среды Qt Creator, TheIDE (Ultimate++), Code::Blocks, Codelite.
% 
% \item При выполнении работы оформите отчёт, содержащий: название работы, текст программы (программ) и~ассемблерный код с~комментариями.
% 
% 
% \end{enumerate}

% Для просмотра содержимого памяти используйте
% возможности отладчика (окна Memory и~Watches, рис.~\ref{lab:digits:ris:digits-debugmemory}).


% 
% \section{Варианты заданий}
% 
% % \providecommand\varlocalcountername{var}
% % % % \newcolumntype{q}[1]{>{\singlespacing\raggedright\arraybackslash}m{#1}}%
% % % % \newcolumntype{o}[1]{>{\singlespacing\centering\arraybackslash}m{#1}}%
% % % \newcolumntype{R}{>{\singlespacing\raggedright\arraybackslash}X}
% % % % \newcolumntype{i}{>{\singlespacing\raggedright\arraybackslash}X}
% % \renewcommand\varlocalcountername{\lablabel:var}
% % \newcounter{\varlocalcountername}
% % \setcounter{\varlocalcountername}{0}
% % 
% % \noindent\begin{tabularx}{\linewidth}{|r<{\refstepcounter{\varlocalcountername}\arabic{\varlocalcountername}.}|R|}
% % \hline
% % \multicolumn{1}{|c|}{\thead{$(\text{ПК}-1)\%\ref{\varlocalcountername:end}+1$}}&\thead{Вариант} \\\hline& 
% % $y(x) = x \% 5 + 2*(x/3)$
% % \\\hline& 
% % $y(x) = x + x/2 +x /4 + x/8$
% % \\\hline
% % \end{tabularx}
% % \addtocounter{\varlocalcountername}{-1}\refstepcounter{\varlocalcountername}\label{\varlocalcountername:end}
% 
% {
% % \footnotesize
% \begin{variants}
% 
% $y(x) = \left\{\begin{array}{ll}
% x \% 5 + 2\cdot(x/3),& x \geqslant 0 \\
% 0, & x < 0 \\
% \end{array}\right.$
% \next
% 
% $y(x) = \left\{\begin{array}{ll}
% x + x/2 +x /4 + x/8, & x\%2 = 0 \\
% x-1, & x\%2 \neq 0 \\
% \end{array}\right.$
% \next
% 
% $y(x) = \left\{\begin{array}{ll}
%  x^3 - (x-1)\cdot(x+1),& -4 \leqslant x \leqslant 4\\
%  0,& x < -4 \vee x > 4\\
% \end{array}\right.$
% \next
% 
% $y(x) = \left\{\begin{array}{ll}
%  (x^2)\%(x+1), & x > -1\\
%  x^3, & x \leqslant -1 \\
% \end{array}\right.$
% \next
% 
% $y(x) = \left\{\begin{array}{ll}
%  1 - x\%3 + x/3, & x < 13\\
%  1 + x, & x \geqslant 13
% \end{array}\right.$
% \next
% 
% $y(x) = \left\{\begin{array}{ll}
%  2x\cdot(x-1) & |x-1|<5\\
%  -2x,& |x-1|\geqslant 5\\
% \end{array}\right.$
% \next
% 
% $y(x) = \left\{\begin{array}{ll}
%  x/2, & x\%2 = 0 \\
% 3x+1, & x\%2 \neq 0 \\
% \end{array}\right.$
% \end{variants}
% }


\theoryrefs
\theoryref{sec:cpp-ide} 

\theoryref{sec:asm-commandsintro}

\theoryref{sec:asm-flags}



% \section{Вопросы}


\section{Вопросы}
\begin{enumerate}
\item Уметь пользоваться окнами просмотра переменных и~содержимого памяти в~отладчике используемой вами IDE.
\item Для чего служит  модификатор volatile в~C++?
\item Для чего служит спецификатор register в~C++?
\item Чем различается размещение в~памяти локальных, глобальных и~статических переменных?

\item Чем различается работа с~целыми числами разной разрядности?
\item Чем различается работа с~целыми и~вещественными числами?
\item Как в~функции передаются целые параметры (в~исследуемом компиляторе и~платформе%
)?
\item Как в~функции передаются вещественные параметры (в~исследуемом компиляторе и~платформе)?
\item Как в~функции передаются три и~более параметров (в~исследуемом компиляторе и~платформе)?
% \item Какие вы знаете соглашения о вызове?

\item Чем различается код, созданный компиляторами одного семейства для различных платформ?
\item Чем различается код, созданный различными компиляторами для одной платформы?

\end{enumerate}

\section{Справочные материалы}

% \subsection{Статьи}
\begingroup
\lstset{keywordstyle=}


\begin{enumerate}

\item Список основных команд архитектур x86 и x86-64 "---
\lstinline!Команды архитектур x86 и x86-64.htm!

\item Черновик стандарта C
% (latest publically available version of the C11 standard) 
(последняя общедоступная версия C11)
"---
\lstinline!n1570.pdf!

\item
Черновик стандарта C++ 
% (C++14 standard plus minor editorial changes) 
(C++14 с~незначительными редакторскими правками)
"---
November 2014 working draft.
\lstinline!n4296.pdf!


\end{enumerate}
\endgroup

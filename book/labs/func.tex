\chapter{Модули и~функции на ассемблере}
\setlablabel{func}


\purpose{
изучить процесс компиляции программы на C++; научиться включать в~проекты на языке C++ ассемблерные модули; научиться описывать функции и~вызывать из программы на языке C++.}




\begin{tasks}

\item
Разработайте ассемблерную функцию, вычисляющую целое выражение от целого аргумента (в~соответствии с~вариантом), а~также головную программу на языке C++, использующую разработанную функцию.
\labellocal{var}

\begin{variants}[asm2c]
$y(x) = 1 + x/2$
\next
$y(x) = x\%4 - x$
\next
$y(x) = 3x+1$
\next
$y(x) = x^3$
\next
$y(x) = 4 - 4x$
\end{variants}

\item
Разработайте программу, целиком написанную на ассемблере, вычисляющую значение $y(x)$ для $x =13$ и~выводящую полученное значение на стандартный вывод с~использованием библиотеки stdlib (в~частности, функции printf).

\item 
%%
% \bonus{+2 балла}  %о%
Опишите функцию на произвольном языке высокого уровня (включая C/C++) и~вызовите её из ассемблерной функции.

\begin{variants}[c2asm]
Вывод двух параметров на экран с~пояснениями
\next
Ввод результата с~клавиатуры
\next
Случайный результат в~заданном диапазоне
\end{variants}

\item \bonus{+2 балла}  Опишите  на ассемблере
% одну функцию  с~параметрами $a, b, \ldots$ и~результатами $x$ и~$y$
% и~вызовите её из другой ассемблерной функции.
одну подпрограмму с~параметрами $a, b, \ldots$ и~результатами $x$ и~$y$
и~вызовите её из другой ассемблерной программы.

\begin{variants}[asm2asm]
$\left\{\begin{array}{ll}
x = a + c\cdot b\\
y = a - c\cdot b\\
\end{array}\right.$
\next
$\left\{\begin{array}{ll}
x = a^2 - b^2\\
y = 2 a b\\
\end{array}\right.$
\end{variants}


\end{tasks}


\theoryrefs
\theoryref{sec:cpp-compile}
\theoryref{sec:asm-func}
\theoryref{sec:asm-calling-conventions}
\theoryref{sec:gas-extern}



\subsection{Подключение к~проекту модулей на ассемблере}
\addquestion{Как подключить к~проекту используемой вами IDE модуль на ассемблере?}
\label{sec:ide-extern}

\subsubsection{Code::Blocks}

Создать ассемблерный модуль в~Code::Blocks можно, используя меню $File \to New \to Empty~file$.
Имя файла обязательно должно иметь расширение \lstinline!.S! (заглавное; расширение \programname{.s} не воспринимается Code::Blocks как допустимое).

После создания в~проекте файла с~таким расширением он во время сборки проекта обрабатывается препроцессором и~компилируется gcc; полученный объектный файл в~дальнейшем используется линкером. Дополнительных настроек делать не нужно.

\subsubsection{Qt~Creator}
% \lstset{frame=top,frame=bottom}


Файл проекта Qt~Creator для добавления ассемблерного модуля \programname{sqr.S} необходимо отредактировать вручную, добавив строку \lstinline!SOURCES += sqr.S!, так как мастер добавления файлов не воспринимает расширения  \programname{.S} и \programname{.s} как допустимые для исходного кода.
% \begin{lstlisting}[caption=Файл проекта, label=lst:pro]
\begin{lstlisting}
TEMPLATE = app
CONFIG += console
CONFIG -= app_bundle
CONFIG -= qt

SOURCES += main.cpp
SOURCES += sqr.S

include(deployment.pri)
qtcAddDeployment()
\end{lstlisting}
Файл  \programname{sqr.S} должен находиться в~той же папке, что и~проект.
Других настроек, кроме редактирования файла проекта, делать не нужно.





\addquestion{Как в~функции передаются целые параметры?}
\addquestion{Как в~функции передаются вещественные параметры?}
\addquestion{Как в~функции передаются три и~более параметров?}



\section{Вопросы}
\begin{enumerate}
\item Какие вы знаете соглашения о~вызове?
\item Какая команда передаёт управление подпрограмме?
\item Какая команда возвращает управление вызывающей программе?
\item Что такое адрес возврата?

\item Какие вы знаете регистры общего назначения?
\item Какие вы знаете команды ассемблера x86?
\item Какие вы знаете флаги?

\end{enumerate}



\section{Справочные материалы}
\begingroup
% \lstset{language=Lisp}
% \lstset{language=[Motorola68k]Assembler}
\lstset{keywordstyle=}


\begin{enumerate}
\item Соглашения о вызовах для различных компиляторов C++ и~операционных систем "---
Agner Fog.
Calling conventions
for different C++ compilers and operating systems.
\lstinline!calling_conventions.pdf!

\item
Атрибуты функций GCC "---
\lstinline!Function Attributes - Using the GNU Compiler Collection (GCC).html!

\item
Расширения файлов GCC "---
C\'{e}dric Musso. Development with GNU/Linux.
\lstinline!GCC and File Extensions - Development with GNU_Linux - labor-liber.html!


\item Список основных команд архитектур x86 и x86-64 "---
\lstinline!Команды архитектур x86 и x86-64.htm!


\item Черновик стандарта C
% (latest publically available version of the C11 standard) 
(последняя общедоступная версия C11)
"---
\lstinline!n1570.pdf!

\item
Черновик стандарта C++ 
% (C++14 standard plus minor editorial changes) 
(C++14 с~незначительными редакторскими правками)
"---
November 2014 working draft.
\lstinline!n4296.pdf!

\end{enumerate}
\endgroup





\chapter{Краткий обзор уровней современной ВС }

\epigraph{
 К~каждой из трёх частей древа относились определенные существа. Вверху, на ветвях изображали птиц, посередине, у~ствола "--- копытных (оленей, лосей, коров, лошадей), иногда человека и~пчёл, а~у~корней "--- змей, лягушек, рыб и~бобров. 
%  Бог восседал на самой верхушке древа. Иногда он вступал в~битву со змеем или драконом и~освобождал похищенный ими скот. Древо, символизировавшее зачатие и~плодородие, изображали на женских одеждах.
 }{Г.\,Белякова}

кратко! Дальше часть того же самого подробнее

\section{Цифровой логический уровень}

\epigraph{
Но да будет слово ваше: «да, да»; «нет, нет»; а~что сверх этого, то от лукавого.
}{Мф. 5:37}

сигналы и~вентили, 0 и~1, триггер как элементарная ячейка памяти, полусумматор, однобитовый сумматор


Сигналы и~вентили

\newcolumntype{Y}{>{$}C<{$}}
\newcolumntype{Z}{>{\columncolor{csMarker}}Y}
\begin{tabularx}{1\linewidth}{YY|YZZ|YYY}
a 	&	b &	\lnot a 	&	\overline{a \land b} 	&	\overline{a \lor b} & a \land b 	&	a \lor b & a \oplus b\\\hline
0 	&	0 	&\multirow{2}{*}{$1$}&	1         	&	1         &0         	&	0         &	0\\
0 	&	1 	&		&	1         	&	0         &0         	&	1         &	1\\\hline
1 	&	0 	&\multirow{2}{*}{$0$}&	1         	&	0         &0         	&	1         &	1\\
1 	&	1 	&		&	0         	&	0         &1         	&	1         &	0\\\hline
\end{tabularx}

\termin{Бит} "--- двоичный разряд (одно состояние).%\raggedright

% \tikz\node [and gate] {};

\includegraphics[width=0.8\linewidth,valign=t]{Logic-gate-index}



\section{Микроархитектурный уровень}
% \epigraph{
% \begin{stanza}[0mm]
% И~орел не взмахивал крылами, \\
% Звёзды жались в~ужасе к~луне, \\
% Если, точно розовое пламя, \\
% Слово проплывало в~вышине.
% \end{stanza}
% }{Н.\,C.\,Гумилёв}
\epigraph{\begin{limerick}
Говорят, в~самом сердце Тибета\\
в~страшной тайне содержится
Это.\\
Но есть мнение, что\\
Это "--- вовсе не То;\\
ничего даже общего где-то.\\
\end{limerick}
}
{С.\,Сатин}


регистр, байт, октет, слово



% Микроархитектура МП – это 
\begin{itemize}
\item аппаратная организация и~логическая структура МП;
\item регистры;
\item управляющие схемы; % (УУ), 
\item арифметико-логические устройства (АЛУ); 
\item запоминающие устройства; 
\item %и~
связывающие их информационные магистрали \rlap{(шины).}
\end{itemize}

% % Шины и~элементы (регистры,  арифметико-логические устройства (АЛУ) и~т.\,д.)
% % \medskip
% % 
% % \termin{Конвейер:}
% % \setlistspacing{1}{0ex}
% % \begin{itemize}
% % \item 
% %     чтение и~декодирование инструкции
% %     
% % \item    загрузка данных
% %     
% % \item    выполнение инструкции
% %     
% %  \item   запись результатов
% % \end{itemize}
% % \medskip
% % 
% % \termin{Тракт данных:}
% % \begin{itemize}
% % \item локальная память
% % % \rlap
% % {(набор регистров);}
% % 
% % \item АЛУ.
% % % арифметико-логическое устройство (АЛУ).
% % \end{itemize}


% \end{tabularx}

\termin{Машинное слово}  "--- разрядность шины данных/регистра.

\termin{Байт} "--- %совокупность битов, обрабатываемая компьютером одномоментно (обычно байт=октет).
минимальный независимо адресуемый \rlap{набор данных.}

\termin{Октет} "--- 8 бит ($2^8 = 256$ состояний).


% Машинное \termin{слово}  "--- разрядность регистров процессора и/или шины данных.



\section{Уровень архитектуры команд}
\epigraph{
\begin{stanza}
Ведь очень скоро у~меня будет Это \\
и~я~буду ясно знать, что с~Этим делать.\\
\end{stanza}
}{\Aquarium}

память, адресация, указатель, команды

\newcommand{\grayemph}[1]{\textcolor{gray}{\emph{#1}}} 

\begin{itemize}
\item    архитектура памяти;
\item    взаимодействие с~внешними устройствами ввода/вывода;
\item    режимы адресации;
\item    регистры;
\item    машинные команды
\begin{itemize}
\item    CISC \grayemph{(complex instruction set computer);}
\item    RISC \grayemph{(reduced instruction set computer, %архитектуры 
load/store);}
\item    VLIW \grayemph{(very long instruction word),} суперскалярные;
\end{itemize}
\item    различные типы внутренних данных (целочисленные, с~плавающей запятой и~т.\,д.);
\item   обработчики прерываний и~исключений.
\end{itemize}

\subsection{Структура команды x86}
\includegraphics[width=1\linewidth,keepaspectratio,valign=t]{cmd_structure}

\subsection{Методы адресации}


\begin{enumerate}
\item \termin{Непосредственная} "--- константа
\item \termin{Прямая} (абсолютная) "--- переменная в~памяти по~фиксированному адресу (статическая)
\item \termin{Регистровая} "--- переменная в~регистре
\item \termin{Косвенно-регистровая (косвенная)} "--- указатель в~регистре
$$
\text{Адрес} = \Reg{Base} + 2^{Scale} \cdot \Reg{Index} + Disp
$$
$\Reg{Base}$ и~$\Reg{Index}$ "--- регистры, $Disp$ "--- смещение (константа)
\end{enumerate}



\subsection{Стек}

\resizebox{1\linewidth}{!}{
\input{book/fragments/stack}
}


\subsection{Порядок следования байтов в~словах}


\begin{tabularx}{1\linewidth}{@{}LL@{}}
\termin{Прямой} (little-endian, Intel, VAX) & \termin{Обратный} (big-endian, Motorola) \\
младший байт слова 
по~младшему адресу
&
младший байт слова 
по~старшему адресу
\\[1ex]
% % \multicolumn{2}{K{0.9\linewidth}}{Число  FE 0A 91 87 в~двойном слове по адресу 0 будет выглядеть в~памяти как}
% \multicolumn{2}{c}{\termin{\texttt{FE 0A 91 87} по адресу~0:}}
% % \multicolumn{2}{c}{ff}
% \\
% \renewcommand{\arraystretch}{1}
% \begin{tabular}{@{}lr@{~}r@{~}r@{~}r@{}}
% &87&91&0A&FE\\
% № байта  &0      &1       &2      &3
% \end{tabular}
% &
% \renewcommand{\arraystretch}{1}
% \begin{tabular}{@{}lr@{~}r@{~}r@{~}r@{}}
% &FE&0A&91&87\\
% № байта  &0      &1       &2      &3
% \end{tabular}
% \multicolumn{2}{c}{\termin{\texttt{0A 0B 0C 0D} по адресу~0:}}
\multicolumn{2}{c}{\termin{\texttt{0x\,0A\,0B\,0C\,0D} по адресу~0:}}
% \multicolumn{2}{c}{ff}
\\
\renewcommand{\arraystretch}{1}
\begin{tabular}{@{}lr@{~}r@{~}r@{~}r@{}}
&0D&0C&0B&0A\\
№ байта  &0      &1       &2      &3
\end{tabular}
&
\renewcommand{\arraystretch}{1}
\begin{tabular}{@{}lr@{~}r@{~}r@{~}r@{}}
&0A&0B&0C&0D\\
№ байта  &0      &1       &2      &3
\end{tabular}
\end{tabularx}

\termin{Переключаемый} (bi-endian, bytesexual)

\termin{Смешанный} (middle-endian, mixed-endian) %"--- машинные слова от старшего к~младшему.
\begin{tabularx}{1\linewidth}{@{}LL@{}}
\renewcommand{\arraystretch}{1}
\begin{tabular}{@{}lr@{~}r@{~}r@{~}r@{}}
PDP-11&0B&0A&0D&0C\\
№ байта  &0      &1       &2      &3
\end{tabular}
&
\begin{tabular}{@{}lr@{~}r@{~}r@{~}r@{}}
&0C&0D&0A&0B\\
№ байта  &0      &1       &2      &3
\end{tabular}
\end{tabularx}





\section{Уровень операционной системы}
\epigraph{
\begin{stanza}
Гора Крукенберг\\
На реке Оккервиль;\\
Река Оккервиль\\
Под горой Крукенберг.\\
\end{stanza}
}{\Aquarium}

управление памятью, загрузка и~выполнение программ, системные вызовы, доступ к~устройствам
% Виртуальная память
% 
% Страничная организация памяти
% 
% % Реализация виртуальных команд ввода-вывода
% Файловая система
% 
% % Виртуальные команды для параллельной работы 
% Процессы

\begin{itemize}
\item    управление памятью (распределение между процессами, организация виртуальной памяти);
\item    загрузка программ в~оперативную память и~их~выполнение;
\item    исполнение запросов программ (системные вызовы);
\item    стандартизованный доступ к~периферийным устройствам (устройства ввода-вывода).
% \item    управление доступом к данным на энергонезависимых носителях (таких как жёсткий диск, оптические диски и др.), организованным в той или иной файловой системе.
% \item    обеспечение пользовательского интерфейса.
% \item    сохранение информации об ошибках системы.
\end{itemize}

\section{Уровень ассемблера}
\epigraph{
\begin{stanza}
Я~прочёл об этом в~старинных трактатах, \\
прочёл и~сразу ушел из деревни;\\
Скоро я~буду баснословно богатым \\
и~смогу претворить в~жизнь учения древних.\\
\end{stanza}
}{\Aquarium}

мнемоники, ассемблирование, ассемблеры

Разным процессорам соответствуют разные языки ассемблера.

Разные компиляторы также поддерживают разный синтаксис.

Мнемоники "--- символическое представление машинных команд.

 \lstinline!B9 CC CC CC CC! $\to$ \lstinline!movl $0xCCCCCCCC, %ecx!


Реализуется путем трансляции (ассемблирования), а~не интерпретации.


\resizebox{0.8\linewidth}{!}{
\tikzstyle{blockarrow}	= [-latex',thick,draw=blue]
\footnotesize
\begin{tikzpicture}[start chain=cpp going below,start chain=S going below,
every on chain/.style=join,every join/.style=blockarrow,
node distance=2ex and 4ex
]
\tikzstyle{block}	= [text width=16ex,text badly centered, minimum height=3ex, draw=black]
\tikzstyle{file}	= [block,  fill=yellow!40!white]
\tikzstyle{stage}	= [block, fill=blue,text=white]


\node[file,on chain=cpp] (prog1_s) {prog.s};
\node[stage,on chain=cpp] (cpp_asm) {Ассемблер};
\node[file,on chain=cpp] (prog1_o) {prog.o};
\node[stage,on chain=cpp] (linker) {Компоновщик};

  
\node[file, right= of linker,text width=20ex] (obj_lib) {Объектные файлы библиотек};
\path[blockarrow] (obj_lib) -- (linker);

\node[file,below= of linker] (prog) {prog};
\path[blockarrow] (linker) -- (prog);


\end{tikzpicture}
}

\begin{itemize}
\item \termin{GNU Assembler (GCC)} "--- более 45 платформ, большинство ОС, лицензия GNU GPL 3+ 
\item \termin{Flat Assembler (FASM)} "--- x86, DOS, MS Windows, UNIX-подобные (GNU/Linux, OpenBSD и др.), MenuetOS, KolibriOS, DexOS,  лицензия BSD 
\item \termin{NASM/Yasm} "--- x86, x86-64, GNU/Linux, DOS, MS Windows, UNIX,  лицензия BSD 
% \item HLASM "--- z/Architecture IBM
\item \termin{Turbo Assembler (TASM)/Lazy Assembler} "--- x86, DOS, MS~Windows
\item \termin{MASM} "--- x86, DOS, MS Windows

\end{itemize}

{} \termin{AT\&T}

\begin{lstlisting}[numbers=none]
movl $42, %eax

movl $0x10, %ebx


lea  -0x30(%rcx,%rax,8), %eax
movl (%ebx), %eax

movl $0xCCCCCCCC, %ecx


movl 0xCCCCCCCC, %ecx
\end{lstlisting}


% -4(%ebp), Intel:  [ebp - 4]
{} \termin{Intel}

\begin{lstlisting}[numbers=none]
mov eax, 42

mov ebx, 10h
mov ebx, 0x10 ; masm

lea eax, [rcx+rax*8-0x30]
mov eax, dword ptr [ebx]

mov ecx, 0xCCCCCCCC   
/*@\textcolor{red}{mov ecx, dword ptr [0xCCCCCCCC] ; masm}@*/
mov ecx, ds:[0xCCCCCCCC]
/*@\textcolor{red}{mov ecx, dword ptr [0xCCCCCCCC] ; nasm}@*/
\end{lstlisting}

\section{Языки высокого уровня}
\epigraph{
\begin{stanza}
Я~буду жить в~доме из костей земли \\
и~с~большой дороги будут заходить дети\\
Чтобы любоваться на мои кристаллы, \\
сияющие во фрактальном свете.\\
\end{stanza}
}{\Aquarium}

языки, компиляторы, GCC

\termin{Прикладное программирование}
% \bigskip

\begin{tabularx}{1\linewidth}{@{}Lp{0.4\linewidth}@{}}
Трансляция
\begin{itemize}
\item Фортран;
% \item Алгол;
\item C/Objective-C/C++;
\item Pascal/Object Pascal/Delphi.
\end{itemize}
&
Интерпретация
\begin{itemize}
\item sh/bash;
\item Python;
\item PHP.
\end{itemize}
\end{tabularx}
Уровень виртуальной машины  Java.
% \begin{itemize}
% \item Java.
% \end{itemize}

\termin{Сверхвысокоуровневые языки программирования}
\begin{itemize}
\item  Python;
\item Ruby;
\item AWK/Perl.
\end{itemize}


\subsection{Компиляторы C++ (x86)}

\begin{itemize}
\item \termin{GNU Compiler Collection (GCC)} "--- более 45 платформ, большинство ОС (порт под MS Windows "---  \termin{MinGW}), %7 языков (в~том числе C и~C++, стандарт), 
лицензия GNU GPL 3+ 
\item \termin{Portable C Compiler (PCC)} "--- Unix-подобные ОС, %GNU/Linux, 
MS Windows; лицензия BSD


\item \termin{TenDRA} "--- x86, x86-64, IA-64; POSIX-совместимые ОС; лицензия BSD

\item \termin{Oracle Solaris Studio} "--- x86, x86-64, SPARC; Solaris, OpenSolaris, GNU/Linux; собственническая лицензия

\item \termin{Intel C++ compiler} "--- x86, x86-64,  IA-64 (Itanium), GNU/Linux, MacOS X, MS Windows, коммерческая собственническая лицензия

\item \termin{Open Watcom} "--- DOS, OS/2 и MS Windows; лицензия  	
Sybase Open Watcom Public License version 1.0, 
%не полностью поддерживает стандарт С++
неполная поддержка стандарта

\item \termin{MS Visual C++} "--- x86, x86-64, IA-64 и~.NET, только MS Windows, коммерческая собственническая лицензия, %грубые 
нарушения стандарта

% \item \termin{Norcroft C Сompiler} "--- Intel Pentium для GNU/Linux, коммерческая собственническая лицензия
% 
% 
% \hrulefill
% \item \termin{Clang} "--- виртуальная RISC-машина LLVM

\end{itemize}

Коллекция GCC:

\termin{gcc} "---  компилятор~C;

\termin{g++} "---  компилятор~C++.

\subsection{Компиляция}

main.cpp
\begin{lstlisting}
int x = 13;
int main()
{
    int y = 2*x + 123;
...
}
\end{lstlisting}

g++ -S main.cpp $\to$

main.s
\begin{lstlisting}
...
.globl	x
	.data
	.align 4
	.type	x, @object
	.size	x, 4
x:
	.long	13
...
	movl	x, %eax
	addl	%eax, %eax
	addl	$123, %eax
	movl	%eax, -12(%ebp)
\end{lstlisting}

\nsection{Контрольные вопросы}

\input{commonpres}


% \setbeamertemplate{itemize/enumerate body begin}{\footnotesize}
% \setbeamertemplate{itemize/enumerate subbody begin}{\footnotesize}
% \setbeamerfont{frametitle}{size=\linespread{1.0}\large}

% \addtobeamertemplate{footnote}{}{\vspace{-30ex}}

% \title{Введение в~язык ассемблера}
\title{Математический сопроцессор}
\graphicspath{{fig/}{fig/fpu/}}


% \lstset{language={[x86masm]Assembler}}
% \lstset{commentline={\/}}
\lstset{xleftmargin=0mm}
% \lstset{language={[Motorola68k]Assembler}}
% alsolanguage=[
% h
% dialect
% i
% ]
% h
% language
\lstset{language=C++, alsolanguage=[x86masm]Assembler}
% \lstset{language=C++, alsolanguage=[Motorola68k]Assembler}



\begin{document}
\maketitle




\section{Структура сопроцессора}

\subsection{Математический сопроцессор}
\begin{frame}{\insertsubsection}
\termin{Математический сопроцессор} (Floating Point Unit, FPU) "--- устройство для обработки числовых данных в~формате с~плавающей точкой

(начиная с~i486DX "--- интегрирован в~процессор, до~Atom "--- имеет почти независимое ядро).

\end{frame}

\subsection{Структура вещественных чисел}
\begin{frame}{\insertsubsection}
$$
(-1)^s \cdot 2^p \cdot m
$$

$0,1_2 \leqslant m < 1$ нормализованное число

$0 \leqslant m < 0,1_2$ денормализованное число

IEEE 754

\end{frame}

\subsection{Регистры сопроцессора}
\begin{frame}{\insertsubsection}
\footnotesize
{
\includegraphics[width=\linewidth,height=\slideheigth,keepaspectratio,valign=t]{fpu_reg}\centering

}

\end{frame}

\begingroup
\renewcommand{\tabularxcolumn}[1]{m{#1}}

\subsection{Стек сопроцессора}
\begin{frame}{\insertsubsection}
% \footnotesize
\scriptsize
{


\begin{tabularx}{1\linewidth}{@{}cL@{}}
\includegraphics[width=\linewidth,height=\slideheigth,keepaspectratio,valign=c]{fpu_push_pop}
&

\includegraphics[width=\linewidth,height=\slideheigth,keepaspectratio,valign=t]{swr}

 текущее состояние сопроцессора после выполнения последней команды
 
 ТОР "--- указатель  вершины стека.
%  шесть флагов исключительных ситуаций;

\bigskip

\includegraphics[width=\linewidth,height=\slideheigth,keepaspectratio,valign=t]{cwr}

шесть масок исключений (i--p)

поле управления точностью рс;

поле управления округлением rс:
\end{tabularx}

}

перерисовать
\end{frame}
\endgroup

% \section{Работа с~сопроцессором}
% \section{Команды сопроцессора}
\section{Сброс и~работа со стеком}

\subsection{Сброс}
\begin{frame}{\insertsubsection}
\small
\setlength{\parskip}{0.5\parskip}

\termin{finit} восстанавливает значения по умолчанию в~регистрах сопроцессора. 

\lstinline!CWR = 0x037F! (округление к~ближайшему, 64-битная мантисса, все исключения замаскированы%
% "--- то есть можно спокойно делить на 0, брать корень из отрицательных чисел и~т.\,п., но результат будет не числом
). 

\lstinline!SWR = 0! (ТОР = 0, никакие флаги исключений не~установлены). 

Регистры данных никак не изменяются, но все они помечаются пустыми в~регистре TWR. 

FIP и~FDP обнуляются. 

\end{frame}

\begingroup
\setbeamerfont{frametitle}{size=\linespread{1.0}\normalsize}


\subsection{Загрузка значений в~стек сопроцессора}
\begin{frame}{\insertsubsection}
\small
\def\normalsize{\small}

\begin{tabularx}{1\linewidth}{|l|L|}
\hline
% \thead{Команда} & \thead{Действие}  %& \thead{Флаги} 
% \\\hline

fld src & Вещественное число
\\\hline

\multicolumn{2}{|c|}{\textbf{Загрузка целых чисел}}\\\hline

fild src & Целое число 
\\\hline

fbld src & Целое двоично-десятичное число 
\\\hline
\multicolumn{2}{|c|}{\textbf{Загрузка констант}}\\\hline
fldz 	&	 0\\\hline
fld1 	&	 1\\\hline
fldpi 	&	 $\pi$\\\hline
fldl2t 	&	 $\log_2 10$\\\hline
fldl2e	&	 $\log_2 e$\\\hline
fldlg2 	&	 $\log_{10} 2$\\\hline
fldln2 	&	 $\ln 2$\\\hline
% \\\hline
\end{tabularx}\end{frame}


\subsection{Выгрузка значений из~стека% сопроцессора
}
\begin{frame}{\insertsubsection}

\def\normalsize{\footnotesize}
\normalsize

\begin{tabularx}{1\linewidth}%{|l|L|}
{|K{5em}@{}|L@{}|}
\hline
% \thead{Команда} & \thead{Действие}  %& \thead{Флаги} 
% \\\hline

fst dst & Копирует вещественное число из вершины стека   в~dst
\\

fstp dst & Выталкивает вещественное число с~вершины стека   в~dst
% 
% Операнд dst может быть переменной в~памяти или пустым регистром сопроцессора
\\\hline

fxch & Меняет местами  st(0) и~st(1)
\\
fxch \%st(i)
& Меняет местами  st(0) и~st(i)
\\\hline
fcmovCC \%st(i), \%st(0) & Условная пересылка st(i) в~st(0)
% 
% Копирует вещественное число из st(i) в~st(0) в~том случае, если в~eflags взведены или сброшены определённые флаги
% 
% Приёмником может быть только st(0)
% \\
% % Команда 	Значения флагов 	Действие после FCOM
% fcmove 	& ZF = 1 \\	%если равно
% fcmovne 	& ZF = 0 \\	%если не равно
% fcmovb 	& CF = 1 \\	%если меньше
% fcmovbe 	& CF = 1 и ZF = 1 \\	%если меньше или равно
% fcmovnb 	& CF = 0 \\	%если не меньше
% fcmovnbe 	& CF = 0 и ZF = 0 \\	%если не меньше или равно
% fcmovu 	& PF = 1 \\	%если несравнимы
% fcmovnu 	& PF = 0 	%если сравнимы
\\\hline

\multicolumn{2}{|c|}{\textbf{Выгрузка с~округлением}}\\\hline

fist dst & Копирует целое число из вершины стека  в~dst
\\
fistp dst & Выталкивает целое число с~вершины стека  в~dst
% 
% Операнд dst может быть только переменной в~памяти
\\\hline


fbst dst & Копирует целое двоично-десятичное число из вершины стека  в~dst
\\
fbstp dst & Выталкивает целое двоично-десятичное число  с~вершины стека в~dst
% 
% Операнд dst может быть только переменной в~памяти
\\\hline

\end{tabularx}
\end{frame}

\section{Команды вычислений}

\subsection{Формы основных арифметических команд}
\begin{frame}{\insertsubsection}

\def\normalsize{\footnotesize}
\def\theadfont{\scriptsize\bfseries}
\normalsize

\begin{tabularx}{1\linewidth}%{|l@{}|l@{}|l@{}|L@{}|}
{|K{8em}|l|l|L|}
\hline
\thead{Команда} &\thead{Источник}&\thead{Приёмник}& \thead{Стек}  %& \thead{Флаги} 
\\\hline
fXXXp

fXXX
&	
 st(0) & st(1)& источник st(0) извлекается из стека
\\\hline
fXXX память
&	
память & st(0)& не изменяется
\\\hline
fiXXX память
&	
память %(целое число)
&st(0)&  не изменяется
\\\hline
fXXX st(i), st(0)
&	
st(i) &  st(0)&  не изменяется
\\\hline
fXXX st(0), st(i)
&	
st(0) &  st(i)&  не изменяется
\\\hline

fXXXp st(0), st(i)
&	
st(0) &  st(i)& % после выполнения команды 
источник st(0) извлекается из стека
% 
% (то есть результат получает обозначение st(i-1))
\\\hline
\end{tabularx}


XXX "--- операция (add, sub, subr, mul, div, divr)

\end{frame}

% 
% \begingroup
% \renewcommand{\tabularxcolumn}[1]{p{#1}}

\subsection{Основные арифметические операции}
\begin{frame}{\insertsubsection}

% \def\normalsize{\small}
% % \def\theadfont{\scriptsize\bfseries}
% \normalsize

\begin{tabularx}{1\linewidth}{|l|L|l|}
\hline
% \thead{Команда} & \thead{Действие}  %& \thead{Флаги} 
% \\\hline
add
&	

Сложение
& $dest := dest + src$
\\\hline
sub
&	
Вычитание
& $dest := dest - src$
\\\hline
subr
&	
Обратное вычитание
& $dest := src - dest$
\\\hline
mul
&	
Умножение
& $dest := dest \cdot src$
\\\hline
div
&	
Деление
& $dest := dest / src$
\\\hline
divr
&
Обратное деление
& $dest := src / dest$
\\\hline
\end{tabularx}
\end{frame}
% \endgroup



\newcommand\subtable[1]{{{
\begin{tabularx}{1\linewidth}{@{}L@{}L@{}}#1\end{tabularx}
}}}

\subsection{Дополнительные арифметические и~трансцендентные команды}
\begin{frame}{\insertsubsection}
\begin{adjustwidth}{-2em}{-2em}

\def\normalsize{\footnotesize}
\def\theadfont{\scriptsize\bfseries}
\normalsize


\begin{tabularx}{1\linewidth}{|l|l|L|}
\hline
\thead{Команда} &\thead{Операнды}&\thead{Результат} %& \thead{Флаги} 
\\\hline
fabs
& 
$x = st(0)$
&
$st(0) = |x|$
\\\hline
fsqrt
&	
$x = st(0)$
&
$st(0) = \sqrt{x}$
\\\hline
fptan
&	
$x = st(0)$
&
\subtable{
$st(0) = 1$,&
$st(1) = \tg(x)$
}
\\\hline
fpatan
&	$x = st(0), y = st(1)$	& $st(0) = \arctg(x/y)$
\\\hline
fsincos
& 
$x = st(0)$
&
\subtable{
$st(0) = \cos(x)$,&
$st(1) = \sin(x)$
}
\\\hline
fsin
&	$x = st(0)$	&	$st(0) = \sin(x)$
\\\hline
fcos
&	$x = st(0)$	&	$st(0) = \cos(x)$
\\\hline
fscale
&	$x = st(0), y = st(1)$	& $st(0) = {x}\cdot 2^{\lfloor y \rfloor}$
\\\hline
f2xmi
&	$x = st(0), x \in (-1, +1)$	&	$st(0) = 2^{x} -1$
\\\hline
fyl2x
&	$x = st(0) \geqslant 0, y = st(1)$	& $st(0) = y\cdot\log_2(x)$
\\\hline
fyl2xp1
&	$
% \begin{array}{l}
x = st(0) \approx 0, y = st(1)
% \\
% -(1 - \sqrt{2}/2)<x<(1 + \sqrt{2}/2)
% \end{array}
$	& $st(0) = y\cdot\log_2(x+1)$
% &
% Вычисляет $st(1)*\log_2\big(st(0)+1\big)$, помещает результат в~st(1) и~выталкивает st(0) из стека, так что после этой операции результат оказывается в~st(0). Первоначальное значение ST(0) должно быть в~пределах от $-(1 - \sqrt{2}/2)\approx -0,3$ до $(1 + \sqrt{2}/2)\approx 1,7$, иначе результат не определён. 
% 
% Команда fyl2xp1 дает б\'{о}льшую точность для st(0), близких к~нулю, чем fyl2x для суммы того же st(0) и~1.
\\\hline

\end{tabularx}
\end{adjustwidth}
\end{frame}

\section{Слово состояния (флаги сопроцессора)}


\subsection{Слово состояния (флаги сопроцессора)
% и~сравнение чисел
}
\colorlet{csControl}{green!50}
\colorlet{csExceptionStatus}{green!7!yellow!7!white}
\colorlet{csSystem}{blue!20!red!10}
\begin{frame}{\insertsubsection}

\setlength{\parskip}{0\parskip}
{
% \begin{adjustwidth}{-1.em}{-1.em}
% \footnotesize
\scriptsize
% \tiny
\renewcommand{\arraystretch}{1.05}
% \vspace{-1.5\baselineskip}

% \begin{tabularx}{0.45\linewidth}{@{}c@{~}|l@{~}|L@{~}}
% % № 	& 	&Название 	&Описание 	&Тип флага \\\hline
% \multicolumn{3}{c}{\Reg{flags/eflags}}\\\hline
% \rowcolor{csMarker}0 	&CF 	&Carry Flag 	\\\hline
% 1 	&1 	&---\\\hline
% \rowcolor{csMarker}2 	&PF 	&Parity Flag 	\\\hline
% 3 	&0 	&---\\\hline
% \rowcolor{csMarker}4 	&AF 	&Auxiliary Carry Flag 	\\\hline
% 5 	&0 	&---\\\hline
% \rowcolor{csMarker}6 	&ZF 	&Zero Flag 	\\\hline
% \rowcolor{csMarker}7 	&SF 	&Sign Flag 	\\\hline
% \rowcolor{csSystem}8 	&TF 	&Trap Flag 	\\\hline
% \rowcolor{csSystem}9 	&IF 	&Interrupt Enable Flag 	\\\hline
% \rowcolor{csControl}10 	&DF 	&Direction Flag 	\\\hline
% \rowcolor{csMarker}11 	&OF 	&Overflow Flag 	\\\hline
% % \rowcolor{csSystem}12 	&\multirow{2}{*}{IOPL} 	 	&\multirow{2}{*}{I/O Privilege Level}\\\hline
% % \rowcolor{csSystem}13 	& 	 	&\\\hline
% \rowcolor{csSystem}12 	& 	 	&\\%\hline
% \rowcolor{csSystem}13 	&\multirow{-2}{*}{IOPL} 	 	&\multirow{-2}{*}{I/O Privilege Level}\\\hline
% \rowcolor{csSystem}14 	&NT 	&Nested Task 	\\\hline
% 15 	&0 	&---\\\hline
% \end{tabularx}
% \begin{tabularx}{0.45\linewidth}{@{}c@{~}|l@{~}|L@{~}}
% % № 	& 	&Название 	\\\hline
% \multicolumn{3}{c}{\Reg{SW}}\\\hline
% \rowcolor{csControl}0 	&IE 	& 	\\\hline
% \rowcolor{csControl}1 	&DE 	&\\\hline
% \rowcolor{csControl}2 	&ZE 	&	\\\hline
% \rowcolor{csControl}3 	&ОЕ 	&\\\hline
% \rowcolor{csControl}4 	&UE 	& 	\\\hline
% \rowcolor{csControl}5 	&РЕ 	&\\\hline
% \rowcolor{csControl}6 	&SF 	&\\\hline
% \rowcolor{csControl}7 	&ES 	&\\\hline
% \rowcolor{csMarker}8 	&C0 	&\\\hline
% \rowcolor{csMarker}9 	&C1 	&\\\hline
% \rowcolor{csMarker}10 	&C2 	&\\\hline
% \rowcolor{csSystem}11 	& 	 	&\\
% \rowcolor{csSystem}12 	& 	 	&\\
% \rowcolor{csSystem}13 	&\multirow{-3}{*}{TOP} 	 	&\multirow{-3}{*}{}\\\hline
% \rowcolor{csMarker}14 	&C3 	&\\\hline
% 15 	&В 	&Busy\\\hline
% \end{tabularx}
\begin{tabularx}{1\linewidth}{@{}c@{~}|l@{~}|L@{~}|c@{~}|l@{~}|l@{~}}
% № 	& 	&Название 	\\\hline
\multicolumn{3}{c}{\Reg{SW}}\\\hhline{---~~~}
\rowcolor{csExceptionStatus}0 	&IE 	& Недействительная операция %(#I)	
&\multicolumn{3}{c}{\cellcolor{white}}\\\hhline{---~~~}
\rowcolor{csExceptionStatus}1 	&DE 	& Денормализованный операнд %(#D)	
&\multicolumn{3}{c}{\cellcolor{white}}\\\hhline{---~~~}
\rowcolor{csExceptionStatus}2 	&ZE 	& Деление на нуль %(#Z)	
&\multicolumn{3}{c}{\cellcolor{white}}\\\hhline{---~~~}
\rowcolor{csExceptionStatus}3 	&ОЕ 	& Переполнение %(#O)	
&\multicolumn{3}{c}{\cellcolor{white}}\\\hhline{---~~~}
\rowcolor{csExceptionStatus}4 	&UE 	& Антипереполнение %(#U)	
&\multicolumn{3}{c}{\cellcolor{white}}\\\hhline{---~~~}
\rowcolor{csExceptionStatus}5 	&РЕ 	& Неточный результат %(#P)	
&\multicolumn{3}{c}{\cellcolor{white}}\\\hhline{---~~~}
\rowcolor{csExceptionStatus}6 	&SF 	& Стековая ошибка	&\multicolumn{3}{c}{\cellcolor{white}}\\\hhline{---~~~}
\rowcolor{csExceptionStatus}7 	&ES 	& Бит суммарной ошибки&\multicolumn{3}{c}{\cellcolor{white}\Reg{eflags}, f(n)stsw + sahf} %&&\multirow{-8}{*}{f(n)stsw/sahf}&
\\\hline
\rowcolor{csMarker}8 	&C0 	&&0 	&CF 	&Carry Flag\\\hline
\rowcolor{csMarker}9 	&C1 	&&\multicolumn{3}{c}{{\cellcolor{white}}игнорируется}\\\hline
\rowcolor{csMarker}10 	&C2 	&&2 	&PF 	&Parity Flag\\\hline
\rowcolor{csSystem}11 	& 	&&\multicolumn{3}{c}{{\cellcolor{white}}игнорируется}\\%\hhline{-~~---}
\rowcolor{csSystem}12 	& 	&&\cellcolor{csMarker}4 	&\cellcolor{csMarker}AF 	&\cellcolor{csMarker}Auxiliary Carry Flag\\
\rowcolor{csSystem}13 	&\multirow{-3}{*}{TOP} 	&\multirow{-3}{*}{}&\multicolumn{3}{c}{{\cellcolor{white}}игнорируется}\\\hline
\rowcolor{csMarker}14 	&C3 	& 	&6 	&ZF 	&Zero Flag\\\hline
\rowcolor{csExceptionStatus}15 	&В 	&Дублирует ES	&7 	&SF 	&Sign Flag \\\hline
\end{tabularx}
% \begin{tabularx}{0.45\linewidth}{@{}c@{~}|l@{~}|L@{~}}
% \\ \\ \\ \\
% \\ \\ \\ \\
% % № 	& 	&Название 	&Описание 	&Тип флага \\\hline
% \multicolumn{3}{c}{\Reg{flags/eflags}}\\\hline
% \rowcolor{csMarker}0 	&CF 	&Carry Flag 	\\\hline
% 1 	&1 	&---\\\hline
% \rowcolor{csMarker}2 	&PF 	&Parity Flag 	\\\hline
% 3 	&0 	&---\\\hline
% \rowcolor{csMarker}4 	&AF 	&Auxiliary Carry Flag 	\\\hline
% 5 	&0 	&---\\\hline
% \rowcolor{csMarker}6 	&ZF 	&Zero Flag 	\\\hline
% \rowcolor{csMarker}7 	&SF 	&Sign Flag 	\\\hline
% \end{tabularx}
% \end{adjustwidth}
}
% \footnotesize
% \vspace{-0.5\baselineskip}

% \scriptsize
% {
% \tiny
% $\left.
% \begin{tabular}{l@{}l}
% $src$ "--- st(i) или в~памяти & 
% $\left\{\begin{tabular}{@{}r@{}}
% fcom[p[p]] [src]\\
% fucom[p[p]] [src]
% \end{tabular}\right.$\\
% $src$ "--- целое в~памяти & ficom[p] src\\
% $src = 0$ & ftst
% \end{tabular}
% \right\}$
% % 
% \begin{tabular}{c@{~}c@{~}c@{~}c}
% Условие & C3 & C0 &C2\\
% $st(0)>src$ & 0 & 0 & 0 \\
% $st(0)<src$ & 0 & 1 & 0 \\
% $st(0)=src$ & 1 & 0 & 0 \\
% несравнимы& 1 & 1 & 1
% \end{tabular}
% % 
% }
% % \vspace{-\baselineskip}
% \footnotesize
\scriptsize

% \hfill
% fstsw \%ax и fnstsw \%ax
f[n]stsw \%ax
"--- выгрузка \Reg{SW} в~\Reg{AX};%/память, 
% \vspace{-\baselineskip}
% 
\hfill
sahf "--- загрузка \Reg{AH} в~младший байт \Reg{eflags}.

\end{frame}


% \subsection{Сравнение с~результатом в~eflags}
\subsection{Команды сравнения}
\newcommand{\farg}[1]{\textbf{\textcolor{green!30!black}{#1}}}
\begin{frame}{\insertsubsection}
\begin{adjustwidth}{-1.em}{-1.em}
\footnotesize
% \setlength{\parskip}{0\parskip}

$\left.
\begin{tabular}{l@{}l}
$src$ "--- st(i) или в~памяти & 
$\left\{\begin{tabular}{@{}r@{}}
\termin{fcom[p[p]]} \farg{[src]}\\
\termin{fucom[p[p]]} \farg{[src]}
\end{tabular}\right.$\\
$src$ "--- целое в~памяти & \termin{ficom[p]} \farg{src}\\
$src = 0$ & \termin{ftst}
\end{tabular}
\right\}$
% 
\begin{tabular}{c|@{~}c@{~}c@{~}c}
Условие & C3 & C0 &C2\\\hline
$st(0)>src$ & 0 & 0 & 0 \\
$st(0)<src$ & 0 & 1 & 0 \\
$st(0)=src$ & 1 & 0 & 0 \\
несравнимы& 1 & 1 & 1
\end{tabular}

{
\vspace{-0.5\baselineskip}
\termin{f[n]stsw + sahf:} C3, C0, C2 $\to$ ZF, CF, PF.
\centering

}

\vspace{-\baselineskip}\hrulefill


\begin{tabular}{r}
\termin{fcomi[p]} \farg{src, \%st(0)}\\
\termin{fucomi[p]} \farg{src, \%st(0)}\\
% $src$ "--- st(i)\hfill \strut сравнивают вершину стека с операндом-источником, который может быть регистром или операндом в памяти (коротким или длинным вещественным).
\end{tabular}
% 
% C2 = 0 "--- ошибка? не могу найти источник
% \begin{tabular}{c|c@{~}c@{~}c|c@{~}c@{~}c|c}
% Условие & ZF & CF &PF	&OF& SF & AF & C2\\\hline
% $st(0)>src$ & 0 & 0 & 0 &\multirow{4}{*}{0} &\multirow{4}{*}{0}  &\multirow{4}{*}{0} &\multirow{4}{*}{0}\\
% $st(0)<src$ & 0 & 1 & 0 &&&&\\
% $st(0)=src$ & 1 & 0 & 0 &&&&\\
% несравнимы& 1 & 1 & 1&&&&
% \end{tabular}
\begin{tabular}{c|c@{~}c@{~}c|c@{~}c@{~}c}
Условие & ZF & CF &PF	&OF& SF & AF \\\hline
$st(0)>src$ & 0 & 0 & 0 &\multirow{4}{*}{0} &\multirow{4}{*}{0}  &\multirow{4}{*}{0} \\
$st(0)<src$ & 0 & 1 & 0 &&&\\
$st(0)=src$ & 1 & 0 & 0 &&&\\
несравнимы& 1 & 1 & 1&&&
\end{tabular}
\end{adjustwidth}
\end{frame}

% \begingroup
% \renewcommand{\tabularxcolumn}[1]{m{#1}}
\subsection{Условная пересылка}
\begin{frame}[fragile]{\insertsubsection}
% \begin{adjustwidth}{-2em}{-2em}

\def\normalsize{\footnotesize}
% \def\normalsize{\scriptsize}
\def\theadfont{\scriptsize\bfseries}
\normalsize
\setlength{\parskip}{0\parskip}

\lstinline!fcmovXXX  %st(i), %st(0)! %"--- 

$st(0) := st(i)$ при %некотором условии
некоторой комбинации флагов \Reg{eflags}


\begin{tabularx}{1\linewidth}{|l|@{}c@{}|%K{7em}|
L|}
% {|K{6em}|X|H|}
\hline
\thead{Команда} 
&
% \thead{Условие (флаги)}  
$
\begin{array}{c}
\text{\textbf{\theadfont Условие}}\\[-0.8ex]
\text{\textbf{\theadfont (флаги)}}\\
\end{array}
$
% & %\theadfont Условие (sub src, dst или \mbox{cmp  src, dst})
% % \thead{Условие (sub src, dst или \mbox{cmp  src, dst})}
% % \thead{Условие (арифметика)}
% % &
% \theadfont Условие (\mbox{cmp  src, dst}) 
& \theadfont Условие \mbox{(f[u]comi[p] src, \%st(0))}
\\\hline
fcmove
&	
$ZF = 1$
% &
% %\multicolumn{2}{c|}
% {$dst = src$}
&
$st(0) = src$\\\hline
fcmovne
&	
$ZF = 0$
% &
% $dst \neq src$
&
$st(0) \neq src$
% 
\\\hline
fcmovb/fcmovnae
&	
$CF = 1$
% &
% $dst < src$ как беззнаковое 
&
$st(0) < src$\\\hline
fcmovna/fcmovbe 	
&
$
\left[
\begin{array}{l}
CF = 1\\
ZF = 1
\end{array}
\right.
$
% &
% $dst \leqslant src$ как беззнаковое 
&
$st(0) \leqslant src$\\\hline
fcmovnb/fcmovae
&	
$CF = 0$
% &
% $dst \geqslant src$ как беззнаковое 
&
$st(0) \geqslant src$\\\hline
fcmova/fcmovnbe
&
$
\left\{
\begin{array}{l}
CF = 0\\
ZF = 0
\end{array}
\right.
$
% &
% $dst > src$ как беззнаковое 
&
$st(0) > src$\\\hline
fcmovu
&	
$PF = 1$
&
% Число единиц младшего байта чётно &
$st(0)$ и~$src$ несравнимы
\\\hline
fcmovnu
&	
$PF = 0$
&
% Число единиц младшего байта нечётно &
$st(0)$ и~$src$ сравнимы
\\\hline



\end{tabularx}
% \end{adjustwidth}
\end{frame}
% \endgroup 

\endgroup 

\section{Примеры}


\subsection{Загрузка и~выгрузка из стека}
\begin{frame}[fragile]{\insertsubsection}
\begin{adjustwidth}{-0em}{-2em}
\scriptsize
\begin{lstlisting}[xleftmargin=0mm]
double x = 5.7, y;
int i = 10;
asm(
    "fldl %[SRC]\n" // st(0) = %[SRC]
    "fldz\n"        // st(0) = 0, st(1) = %[SRC]
    "fld1\n"        // st(0) = 1, st(1) = 0, st(2) = %[SRC]
    "fild %[I]\n"   // st(0) = %[I], st(1) = 1, st(2) = 0, st(3) = %[SRC]
    "fstpl %[DST]\n"// %[DST] = %[I],   st(0) = 1, st(1) = 0, st(2) = %[SRC]
    "fstpl %[DST]\n"// %[DST] = 1,      st(0) = 0, st(1) = %[SRC]
    "fstpl %[DST]\n"// %[DST] = 0,      st(0) = %[SRC]
    "fstpl %[DST]\n"// %[DST] = %[SRC], стек пуст

    :[DST]"=m"(y)
    :[SRC]"m"(x), [I]"m"(i)
    :"cc"
); // y = x и много лишних действий
\end{lstlisting}
\end{adjustwidth}
\end{frame}

\subsection{Арифметические операции}
\begin{frame}[fragile]{\insertsubsection}
\begin{adjustwidth}{-1em}{-2em}
\scriptsize
\begin{lstlisting}[xleftmargin=0mm]
const double a = 0.01;
double x = 5, y;
int i = 10;
asm(
    "fldl %[SRC]\n" // st(0) = %[SRC]
    "fldpi\n"       // st(0) = pi, st(1) = %[SRC]
    "fld1\n"        // st(0) = 1, st(1) = pi, st(2) = %[SRC]
    "fildl %[I]\n"  // st(0) = %[I], st(1) = 1, st(2) = pi, st(3) = %[SRC]
    "fdivr\n"       // st(0) = 1/%[I], st(1) = pi, st(2) = %[SRC]
    "fldl  %[A]\n"  // st(0) = %[A], st(1) = 1/%[I], st(2) = pi, st(3) = %[SRC]
    "fmulp %%st(0), %%st(2)\n"  // st(0) = 1/%[I], st(1) = pi*%[A], st(2) = %[SRC]
    "faddp\n"       // st(0) = 1/%[I] + pi*%[A], st(1) = %[SRC]
    "faddp\n"       // st(0) = 1/%[I] + pi*%[A] + %[SRC]
    "fstpl %[DST]\n"// %[DST] = 1/%[I] + pi*%[A] + %[SRC], стек пуст

    :[DST]"=m"(y)
    :[SRC]"m"(x), [A]"m"(a), [I]"m"(i)
    :"cc"
);// y = x + 1/i + a*pi
\end{lstlisting}
\end{adjustwidth}
\end{frame}



\subsection{Тригонометрические операции}
\begin{frame}[fragile]{\insertsubsection}
\scriptsize
\begin{lstlisting}[xleftmargin=0mm]
const double a = 100;
double x = M_PI/6, y;
asm(
    "fldl %[SRC]\n" // st(0) = %[SRC]
    "fsincos\n"     // st(0) = cos(%[SRC]), st(1) = sin(%[SRC])
    "fmull %[A]\n"  // st(0) = %[A]*cos(%[SRC]), st(1) = sin(%[SRC])
    "fadd\n"        // st(0) = %[A]*cos(%[SRC]) + sin(%[SRC])
    "fstpl %[DST]\n"// %[DST] = %[A]*cos(%[SRC]) + sin(%[SRC]) стек пуст

    :[DST]"=m"(y)
    :[SRC]"m"(x), [A]"m"(a)
    :"cc"
);	// y = a*cos(x) + sin(x)
\end{lstlisting}
\end{frame}



% *****************************************************************************
\section{}
\begin{frame}{Вопросы}
% \setlength{\leftmargini}{0ex}
% \setlength{\parskip}{0.25\parskip}
\begin{enumerate}

\item Какие регистры используются в~сопроцессоре для хранения операндов?

\item Какие команды используются для выполнения арифметических операций над вещественными числами?

\item Какие команды используются для выполнения тригонометрических операций?

\end{enumerate}

\end{frame}

\makethanks
\end{document}

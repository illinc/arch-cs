\input{commonpres}


% \setbeamertemplate{itemize/enumerate body begin}{\footnotesize}
% \setbeamertemplate{itemize/enumerate subbody begin}{\footnotesize}
% \setbeamerfont{frametitle}{size=\linespread{1.0}\large}

% \addtobeamertemplate{footnote}{}{\vspace{-30ex}}

% \title{Введение в~язык ассемблера}
\title{Математический сопроцессор}
\graphicspath{{fig/}{fig/fpu/}}


% \lstset{language={[x86masm]Assembler}}
% \lstset{commentline={\/}}
\lstset{xleftmargin=0mm}
% \lstset{language={[Motorola68k]Assembler}}
% alsolanguage=[
% h
% dialect
% i
% ]
% h
% language
\lstset{language=C++, alsolanguage=[x86masm]Assembler}
% \lstset{language=C++, alsolanguage=[Motorola68k]Assembler}



\begin{document}
\maketitle




\section{Структура FPU}

\subsection{Математический сопроцессор}
\begin{frame}{\insertsubsection}
\termin{Математический сопроцессор} (Floating Point Unit, FPU) "--- устройство для обработки числовых данных в~формате с~плавающей запятой

(начиная с~i486DX "--- интегрирован в~процессор, до~Atom "--- имеет почти независимое ядро).

\end{frame}

% \subsection{Структура вещественных чисел}
% \begin{frame}{\insertsubsection}
% $$
% (-1)^s \cdot 2^p \cdot m
% $$
% 
% $0,1_2 \leqslant m < 1$ нормализованное число
% 
% $0 \leqslant m < 0,1_2$ денормализованное число
% 
% IEEE 754
% 
% \end{frame}
\subsection{Структура вещественного числа с~плавающей запятой (IEEE~754)}

\tikzstyle{block}	= [text badly centered, minimum height=4ex, draw=black,  fill=clMemoryLight, solidchaincell]
\tikzstyle{blabel}	= [scale=0.7]


\newcommand{\real}[5][]
{
  \node[block, minimum width= 42 ex, on chain, #1]  (m)  {$#4$};
  \node[block, minimum width= 18 ex, on chain]  (p) {$#3$};
  \node[block, minimum width= 4 ex, on chain]  (s) {$#2$};
  
%     \node[left = 2ex of s] {\asbuk{risletter})\stepcounter{risletter}};
    \node[right = 2ex of m] {$#5$};
%   \tikzset{node distance=2ex}

  \foreach \nd/\s/\e in {m/0/n-1, p/n/n+w-1}
%   \foreach \nd/\s/\e in {\pmbits}
  {
    \node[below right = of \nd.south west, blabel, anchor=north west] (be) {$\mathstrut\e$};
    \node[below left = of \nd.south east, blabel, anchor=north east] (bs) {$\mathstrut\s$};
%   \coordinate[left =  of \nd.south east, label=below:$\mathstrut\s$] (bs);
  };
  \node[below = of s, blabel]  {$\mathstrut n+w$};
}
\setcounter{risletter}{1}


\begin{frame}{\insertsubsection}

\resizebox{\linewidth}{!}
{
\begin{tikzpicture}[
start chain=going left,
node distance=0ex,
% baseline=(current bounding box.north)
]

  \real{s}{p+\xi}{m_2 m_3 m_4\ldots m_{n+1}}{	
    \begin{array}{@{}c@{}}
      (-1)^s\cdot 2^p \cdot \overline{0,1m_2 m_3 m_4\ldots m_{n+1}}\\
      p_{min} \leqslant p \leqslant p_{max}
    \end{array}
  }
%   \foreach \p/\m/\letter/\pos in {p+\xi/m_2 m_3\ldots m_{n+1}/а)/,p+\xi/m_2 m_3\ldots m_{n+1}/а)/,}
%   {
%     \real[]{s}{\p}{\m}
%   };
\tikzstyle{nextm}	= [below = 6ex of m]

%   \real[nextm]{s}{000\ldots000}{m_1 m_2 m_3\ldots m_{n}}
  \real[nextm]{s}{000\ldots000}{m_2 m_3 m_4\ldots m_{n+1}}{	(-1)^s\cdot 2^{p_{min}} \cdot \overline{0,0m_2 m_3 m_4\ldots m_{n+1}}	}
  \real[nextm]{s}{000\ldots000}{000\ldots 0}{	(-1)^s\cdot 0	}
%   \real[nextm]{s}{000\ldots000}{000\ldots 0}{	\pm 0	}

  \real[nextm]{s}{111\ldots111}{000\ldots 0}{	(-1)^s\cdot \infty	}
%   \real[nextm]{s}{111\ldots111}{000\ldots 0}{	\pm \infty	}
  \real[nextm]{x}{111\ldots111}{q x x\ldots x}{\text{нечисло}~(nan)}

\end{tikzpicture}
}

\setlength{\parskip}{0.1\parskip}
\scriptsize

32 бита "--- одинарная точность, $float$; 
\mbox{64~бита "--- двойная точность, $double$}

\end{frame}


\subsection{Структура значения FPU}

\renewcommand{\real}[5][]
{
  \node[block, minimum width= 42 ex, on chain, #1]  (m)  {$#4$};
  \node[block, minimum width= 18 ex, on chain]  (p) {$#3$};
  \node[block, minimum width= 4 ex, on chain]  (s) {$#2$};
  \node[fit = (m) (p) (s)] (body) {};
  
%     \node[left = 2ex of s] {\asbuk{risletter})\stepcounter{risletter}};
    \node[right = 1ex of m] (vlabel) {$#5$};
%   \tikzset{node distance=2ex}

  \foreach \nd/\s/\e in {m/0/63, p/64/78}
%   \foreach \nd/\s/\e in {\pmbits}
  {
    \node[below right = of \nd.south west, blabel, anchor=north west] (be) {$\e$};
    \node[below left = of \nd.south east, blabel, anchor=north east] (bs) {$\s$};
%   \coordinate[left =  of \nd.south east, label=below:$\mathstrut\s$] (bs);
  };
  \node[below = of s, blabel]  {$79$};
}
\tikzstyle{block}	= [text badly centered, minimum height=4ex, draw=black,  fill=clRegisterLight, solidchaincell]
\tikzstyle{nextm}	= [below = 6ex of m]

\begin{frame}{\insertsubsection}
\begin{adjustwidth}{-1.9em}{-2em}


\setcounter{risletter}{1}

\resizebox{\linewidth}{!}
{
\begin{tikzpicture}[
start chain=going left,
node distance=0ex,
% baseline=(current bounding box.center)
]

  \real{s}{p+\xi}{1 m_2 m_3 m_4\ldots m_{n}}{	
    \begin{array}{@{}c@{}}
      (-1)^s\cdot 2^p \cdot \overline{0,1m_2 m_3 m_4\ldots m_{n}}\\
      p_{min} \leqslant p \leqslant p_{max}
    \end{array}
  }
  \node[above = of body, scale=2]  {Корректные значения};

  \real[nextm]{s}{000\ldots000}{0 m_2 m_3 m_4\ldots m_{n}}{	(-1)^s\cdot 2^{p_{min}} \cdot \overline{0,0m_2 m_3 m_4\ldots m_{n}}	}
  \real[nextm]{s}{000\ldots000}{000\ldots 0}{	(-1)^s\cdot 0	}
%   \real[nextm]{s}{000\ldots000}{000\ldots 0}{	\pm 0	}

  \real[nextm]{s}{111\ldots111}{000\ldots 0}{	(-1)^s\cdot \infty	}
%   \real[nextm]{s}{111\ldots111}{000\ldots 0}{	\pm \infty	}
  \real[nextm]{1}{111\ldots111}{110\ldots 0}{    \begin{array}{@{}c@{}}
\text{неопределённость}
% \\(nan)
    \end{array}}
\coordinate[right = 0em of vlabel] (uvbase); 
%   \real[nextm]{x}{111\ldots111}{q x x\ldots x}{}
  \real[nextm]{x}{111\ldots111}{11x\ldots x}{\begin{array}{@{}l@{}}\text{тихое нечисло}\\(qnan)
    \end{array}}
  \real[nextm]{x}{111\ldots111}{10x\ldots x}{\begin{array}{@{}l@{}}\text{сигнальное нечисло}\\(snan)
    \end{array}}
% %   \real[nextm]{x}{111\ldots111}{0xx\ldots x}{\text{недопустимое значение}}
%   \real[nextm]{x}{xxx\ldots xxx}{0xx\ldots x}{\text{недопустимое значение}}

% \end{tikzpicture}
% }
% \resizebox{0.3\linewidth}{!}
% {
% \begin{tikzpicture}[
% start chain=going left,
% node distance=0ex,
% baseline=(current bounding box.north)
% ]
% \coordinate[on chain, left = 0em of uvbase] (uv); 
% 
%   \real[nextm]{x}{000\ldots 000}{1xx\ldots x}{\exists y\neq 0}
%   \real[nextm]{x}{yyy\ldots yyy}{0yy\ldots y}{\exists y\neq 0}
  \real[right = 12em of uvbase]{x}{000\ldots 000}{1xx\ldots x}{}
  
  \node[above = of body, scale=2]  {Недопустимые значения};
  \real[nextm]{x}{111\ldots 111}{0yy\ldots y}{\exists y\neq 0}
  \real[nextm]{x}{yyy\ldots yyy}{0xx\ldots x}{   
    \begin{array}{@{}l@{}}
      \exists y\neq 0,\\ \exists y\neq 1
    \end{array}
  }

\end{tikzpicture}
}
\end{adjustwidth}

\end{frame}


\subsection{Регистры FPU}
\begin{frame}{\insertsubsection}

\resizebox{\linewidth}{!}
{
\input{book/drawings/fpureg}
}


\end{frame}

\begingroup
\subsection{Флаги FPU}


% Рисование регистров

\tikzmath{real \bitwidthex, \halfbitex; 
  \bitwidthex=7; 
  \halfbitex = \bitwidthex/2;}
  
\tikzstyle{bitlabel}	= []
\tikzstyle{block}	= [text badly centered, minimum height=\bitwidthex ex, draw=black]
\tikzstyle{reg}	= [block,  fill=clRegisterLight]
\tikzstyle{bit}	= [reg, solidchaincell, minimum width=\bitwidthex ex]

\newcommand{\onebit}[3][]
{
  \node[bit, on chain, label=below:$#2$, #1] (#2) {$#3$};
}

\newcommand{\bitfield}[4][]
{
  \tikzmath{int \bits, \wdex; \bits = #3 - #2 + 1;
    \wdex = \bits * \bitwidthex;}
  \node[bit, minimum width= \wdex ex, on chain, #1] (#2)  {$#4$};
  \coordinate[right = \halfbitex ex of #2.south west, label=below:$#3$] (be#3);
  \coordinate[left = \halfbitex ex of #2.south east, label=below:$#2$] (bs#2);
}

\newcommand{\regfloat}[4][]
{
\begin{tikzpicture}[
baseline=(mant0.base)
]
  \tikzmath{  \bitwidthex=4; }
  \node[reg, solidchaincell, minimum width=32ex, #1]  (mant0) {$#4$};
  \node[reg, solidchaincell, minimum width=10ex, left = of mant0, #1]  (exp0) {$#3$};
  \node[bit, solidchaincell, left = of exp0, #1]  (sign0) {$#2$};
\tikzstyle{bitlabel}	= [scale=0.7]  
\node[above = 0ex of exp0, bitlabel]  (exp) {Порядок};
\node[anchor=base, bitlabel] at (exp.base-|sign0) (sign) {Знак};
\node[bitlabel] at (exp-|mant0)  {Мантисса};  
\end{tikzpicture}
}


\begin{frame}{\insertsubsection}
\setlength{\parskip}{0.5\parskip}

\resizebox{\linewidth}{!}
{
\input{book/drawings/fpureg-sw-cw}
}
% \footnotesize
\scriptsize
% 
% $top$ "--- указатель  вершины стека
%  
% $pc$ "--- поле управления точностью
% 
% $rc$ "--- поле управления округлением
\begin{tabularx}{1\linewidth}{@{}L@{}L@{}}
$top$ "--- указатель  вершины стека & $C0{-}C3$ "--- флаги состояния \\
%  $PC$ "--- поле управления точностью & $RC$ "--- поле управления округлением \\
% $SF$ "--- флаг немаскируемой ошибки стека
% &
% $ES$ "--- флаг незамаскированной ошибки
\end{tabularx}

шесть флагов/масок исключительных ситуаций

\scriptsize
\begin{tabularx}{1\linewidth}{@{\hspace{2em}}l@{ "--- }Ll@{ "--- }L}
\#I & \textbf{недействительная операция} & \#О & переполнение  порядка\\
% Может быть стековой ошибкой~\textbf{\#IS}  или недопустимой арифметической операцией~\textbf{\#IA}.
% \paragraph{\#IS} Стековая ошибка (Stack Fault) "--- попытка записи в~полностью заполненный стек или чтения из пустой ячейки стека FPU.
% Недействительной арифметической операцией~\textbf{(\#IA)} считается операция, проводимая над некорректными аргументами.
% В~этом случае может также возникнуть одна из следующих пяти ситуаций.
\#D & денормализованный операнд &\#U & исчезновение порядка\\
\#Z & деление на ноль & \#Р & неточный результат \\
\end{tabularx}

$SF$ "--- флаг немаскируемой ошибки стека
\\
$ES$ "--- флаг незамаскированной ошибки
% \medskip

% \begin{tabularx}{1\linewidth}{@{}L@{}L@{}}
% $SF$ "--- немаскируемая ошибка стека
% &
% $ES$ "--- флаг незамаскированной ошибки
% \end{tabularx}

\begin{tabularx}{1\linewidth}{@{}L@{}L@{}}
 $PC$ "--- поле управления точностью & $RC$ "--- поле управления округлением \\
\end{tabularx}
\end{frame}
\endgroup

\begingroup
\renewcommand{\tabularxcolumn}[1]{m{#1}}

\section{Загрузка, выгрузка и~пересылка}

\subsection{Стек FPU}
\begin{frame}{\insertsubsection}
\small
\setlength{\parskip}{0.5\parskip}

$r_0{-}r_{7}$ образуют кольцевой буфер-стек
\\
$r_{top}$ "--- вершина стека $st(0)$

\resizebox{\linewidth}{!}
{
\input{book/drawings/fpu-top-change}
}

\end{frame}
\endgroup

% \section{Работа с~сопроцессором}
% \section{Команды сопроцессора}
% \section{Сброс и~работа со стеком}

% \subsection{Сброс}
% \begin{frame}{\insertsubsection}
% \small
% \setlength{\parskip}{0.5\parskip}
% 
% \termin{finit} восстанавливает значения по умолчанию в~регистрах сопроцессора. 
% 
% \lstinline!CWR = 0x037F! (округление к~ближайшему, 64-битная мантисса, все исключения замаскированы%
% % "--- то есть можно спокойно делить на 0, брать корень из отрицательных чисел и~т.\,п., но результат будет не числом
% ). 
% 
% \lstinline!SWR = 0! (ТОР = 0, никакие флаги исключений не~установлены). 
% 
% Регистры данных никак не изменяются, но все они помечаются пустыми в~регистре TWR. 
% 
% FIP и~FDP обнуляются. 
% 
% \end{frame}

\begingroup
\setbeamerfont{frametitle}{size=\linespread{1.0}\normalsize}


\subsection{Загрузка значений в~стек FPU}
\begin{frame}{\insertsubsection}
\small
\def\normalsize{\small}

\begin{tabularx}{1\linewidth}{|>{\ttfamily}l|L|}
\hline
% \thead{Команда} & \thead{Действие}  %& \thead{Флаги} 
% \\\hline

fld src & Вещественное число
\\\hline

\multicolumn{2}{|c|}{\textbf{Загрузка целых чисел}}\\\hline

fild smem & Целое знаковое число 
\\\hline

fbld smem & Целое двоично-десятичное  80-битное упакованное знаковое число 
\\\hline
\multicolumn{2}{|c|}{\textbf{Загрузка констант}}\\\hline
fldz 	&	 0\\\hline
fld1 	&	 1\\\hline
fldpi 	&	 $\pi$\\\hline
fldl2t 	&	 $\log_2 10$\\\hline
fldl2e	&	 $\log_2 e$\\\hline
fldlg2 	&	 $\log_{10} 2$\\\hline
fldln2 	&	 $\ln 2$\\\hline
% \\\hline
\end{tabularx}\end{frame}


\subsection{Выгрузка и~пересылка значений}
\begin{frame}{\insertsubsection}
% \begin{adjustwidth}{-1.1em}{-1.1em}

\def\normalsize{\footnotesize}
\normalsize

\begin{tabularx}{1\linewidth}%{|l|L|}
{|>{\ttfamily}l@{~}|L@{~}|}
\hline
% \thead{Команда} & \thead{Действие}  %& \thead{Флаги} 
% \\\hline

fst dst & Копирует $st(0)$  в~$dst$
\\

fstp dst & Выталкивает $st(0)$ в~$dst$
% 
% Операнд dst может быть переменной в~памяти или пустым регистром сопроцессора
\\\hline

\multicolumn{2}{|c|}{\textbf{Выгрузка с~округлением}}\\\hline

fist dmem & Копирует $st(0)$  в~$dmem$ как целое
\\
fistp dmem & Выталкивает $st(0)$  в~$dmem$ как целое
% 
% Операнд dst может быть только переменной в~памяти
\\\hline


fbst dmem & Копирует $st(0)$  в~$dmem$ как двоично-десятичное 80-битное целое
\\
fbstp dmem & Выталкивает $st(0)$ в~$dmem$ как двоично-десятичное 80-битное целое
% 
% Операнд dst может быть только переменной в~памяти
\\\hline
\multicolumn{2}{|c|}{\textbf{Переименование и пересылка внутри стека}}\\\hline

fxch & Меняет местами  $st(0)$ и~$st(1)$
\\
fxch \%st(i)
& Меняет местами  $st(0)$ и~$st(i)$
\\\hline
fcmovCC \%st(i),\%st(0) & Условная пересылка $st(i)$ в~$st(0)$
\\\hline
\end{tabularx}
% \end{adjustwidth}
\end{frame}

\subsection{Загрузка и~выгрузка флагов}
\begin{frame}{\insertsubsection}


\small
\begin{tabularx}{\linewidth}{|>{\ttfamily}l|L|}
\hline
\normalfont\thead{Команда} & \thead{Действие} 
\\\hline
fnstcw dmem16	&	Выгрузка управляющего слова~$cw$ в~память  \\\hline
fldcw smem16	&	Загрузка управляющего слова~$cw$ из~памяти  \\\hline
fnstsw dest16	&	Выгрузка (разрушающая) слова состояния~$sw$ в~память или регистр~$ax$ \\\hline
\end{tabularx}
\end{frame}

\section{Команды вычислений}


% 
% \begingroup
% \renewcommand{\tabularxcolumn}[1]{p{#1}}

\subsection{Основные арифметические операции}
\begin{frame}{\insertsubsection}
\begin{adjustwidth}{-1.1em}{-1.1em}

% \def\normalsize{\small}
% % \def\theadfont{\scriptsize\bfseries}
% \normalsize
\footnotesize

\begin{tabularx}{1\linewidth}{|l@{~}>{\scriptsize (}l<{)}|L|L|}
\hline
\multicolumn{2}{|c|}{\thead{Команда}} & \thead{Intel}  & \thead{GAS*} 
\\\hline
\lstinline!fadd!
&
сложение
&	
\multicolumn{2}{c|}{ $dest ~~ = ~~ dest + src~~ = ~~st(0) + \xi$}
\\\hline
\lstinline!fsub!
&
вычитание
&	
{$dest = dest - src$}
&
{$dest =  st(0) - \xi$}
\\\hline
\lstinline!fsubr!
&
обратное вычитание
&
{$dest = src - dest$}
&
{$dest =  \xi - st(0)$}
\\\hline
\lstinline!fmul!
&
умножение
&	
\multicolumn{2}{c|}{$dest ~~ =~~ dest \cdot src ~~=~~ st(0) \cdot \xi$}
\\\hline
\lstinline!fdiv!
&
деление
&	
{$dest = dest / src$}
&
{$dest =  st(0)/\xi$}
\\\hline
\lstinline!fdivr!
&
обратное деление
&
{$dest = src / dest$}
&
{$dest =  \xi/st(0)$}
\\\hline

\end{tabularx}

*
%Один из операндов всегда находится на вершине стека~$st(0)$.
% Обозначим другой операнд как~$x$.
$\xi$ "--- операнд, не лежащий на~вершине стека.

Может быть как источником, так и~приёмником, в~зависимости от используемой формы.

\end{adjustwidth}
\end{frame}
% \endgroup


\subsection{Формы основных арифметических команд}
\begin{frame}{\insertsubsection}
\begin{adjustwidth}{-1.1em}{-1.1em}

\def\normalsize{\footnotesize}
\def\theadfont{\scriptsize\bfseries}
\normalsize

\begin{tabularx}{1\linewidth}%{|l@{}|l@{}|l@{}|L@{}|}
{|>{\ttfamily}l|>{$}L<{$}|>{$}l<{$}|K{7em}|}
\hline
\normalfont\thead{Команда} &\text{\thead{Источник}}&\text{\thead{Приёмник}}& \thead{Стек}  %& \thead{Флаги} 
\\\hline
fXXX smem
&	
smem & st(0)& не изменяется
\\\hline
fiXXX smem
&	
smem %(целое число)
&st(0)&  не изменяется
\\\hline
fXXX st(i), st(0)
&	
st(i) &  st(0)&  не изменяется
\\\hline
fXXX st(0), st(i)
&	
st(0) &  st(i)&  не изменяется
\\\hline

fXXXp st(0), st(i)
&	
st(0) &  st(i) \to st(i-1)& % после выполнения команды 
источник $st(0)$ выталкивается
% 
% (то есть результат получает обозначение st(i-1))
\\\hline
fXXXp
% fXXX
&	
 st(0) & st(1) \to st(0) & источник $st(0)$ выталкивается
\\\hline

\end{tabularx}


XXX "--- операция (add, sub, subr, mul, div, divr)

\end{adjustwidth}
\end{frame}

\newcommand\subtable[1]{{{
\begin{tabularx}{1\linewidth}{@{}L@{}L@{}}#1\end{tabularx}
}}}

\subsection{Дополнительные арифметические и~трансцендентные команды}
\begin{frame}{\insertsubsection}
\begin{adjustwidth}{-1.1em}{-1.1em}

\def\normalsize{\footnotesize}
\def\theadfont{\scriptsize\bfseries}
\normalsize


\begin{tabularx}{1\linewidth}{|>{\ttfamily}l|l|L|}
\hline
\normalfont\thead{Команда} &\thead{Операнды}&\thead{Результат} %& \thead{Флаги} 
\\\hline
fabs
& 
$x = st(0)$
&
$st(0) = |x|$
\\\hline
fsqrt
&	
$x = st(0)$
&
$st(0) = \sqrt{x}$
\\\hline
fptan
&	
$x = st(0)$
&
\subtable{
$st(0) = 1$,&
$st(1) = \tg(x)$
}
\\\hline
fpatan
&	$x = st(0), y = st(1)$	& $st(0) = \arctg(x/y)$
\\\hline
fsincos
& 
$x = st(0)$
&
\subtable{
$st(0) = \cos(x)$,&
$st(1) = \sin(x)$
}
\\\hline
fsin
&	$x = st(0)$	&	$st(0) = \sin(x)$
\\\hline
fcos
&	$x = st(0)$	&	$st(0) = \cos(x)$
\\\hline
fscale
&	$x = st(0), y = st(1)$	& $st(0) = {x}\cdot 2^{\lfloor y \rfloor}$
\\\hline
f2xmi
&	$x = st(0), x \in (-1, +1)$	&	$st(0) = 2^{x} -1$
\\\hline
fyl2x
&	$x = st(0) \geqslant 0, y = st(1)$	& $[st(1)\to st(0)] = y\cdot\log_2(x)$
\\\hline
fyl2xp1
&	$
% \begin{array}{l}
x = st(0) \approx 0, y = st(1)
% \\
% -(1 - \sqrt{2}/2)<x<(1 + \sqrt{2}/2)
% \end{array}
$	& $[st(1)\to st(0)] = y\cdot\log_2(x+1)$
% &
% Вычисляет $st(1)*\log_2\big(st(0)+1\big)$, помещает результат в~st(1) и~выталкивает st(0) из стека, так что после этой операции результат оказывается в~st(0). Первоначальное значение ST(0) должно быть в~пределах от $-(1 - \sqrt{2}/2)\approx -0,3$ до $(1 + \sqrt{2}/2)\approx 1,7$, иначе результат не определён. 
% 
% Команда fyl2xp1 дает б\'{о}льшую точность для st(0), близких к~нулю, чем fyl2x для суммы того же st(0) и~1.
\\\hline
\lstinline!fprem1!
&
$x = st(0), y = st(1)$ &
$[st(1)\to st(0)] = x \Mod y$ 
\\\hline

\end{tabularx}
\end{adjustwidth}
\end{frame}

\section{Сравнение вещественных чисел}


\subsection{Команды сравнения}
\begin{frame}{\insertsubsection}
\begin{adjustwidth}{-1.1em}{-1.1em}
\footnotesize
% \setlength{\parskip}{0\parskip}
\scriptsize
\begin{tabularx}{\linewidth}{|>{\ttfamily}l|>{$}c<{$}|>{$}c<{$}|L|}
\hline
\normalfont\thead{Команда} & \text{\thead{Источник}}  & \text{\thead{Флаги}} & \thead{Особенности}
\\\hline
fcom[p[p]]	&	st(1) 	&	\multirow{6}{*}{$C0, C3, C2$}	&	\\
fcom[p] src	&	src   	&			&	\\
% fcomp		&	st(1) 	&	C0, C3, C2	\\
% fcomp src	&	src   	&	C0, C3, C2	\\
% fcompp		&	st(1) 	&	C0, C3, C2	\\
\hhline{|-|-|~|-|}
fucom[p[p]]	&	st(1) 	&		&Нет исключения \\
fucom[p] src	&	src   	&		& при сравнении %тихих нечисел
с~$qnan$\\
\hhline{|-|-|~|-|}
ficom[p] smem	&	smem   	&		&	$smem$ "--- целое число\\
\hhline{|-|-|~|-|}
ftst		&	0   	&		&	\\
\hline
fcomi[p] \%st(i), \%st(0)	& st(i)	&	\multirow{2}{*}{$CF, ZF, PF$}	&	\\
\hhline{|-|-|~|-|}
fucomi[p] \%st(i), \%st(0)	& st(i)	&		&	Нет исключения при~сравнении %тихих нечисел 
с~$qnan$
\\\hline
\end{tabularx}
% \end{adjustwidth}
% \end{frame}
% 
% 
% \subsection{Флаги сравнения}
% \begin{frame}{\insertsubsection}
% \begin{adjustwidth}{-1.1em}{-1.1em}
% \footnotesize
% \setlength{\parskip}{0\parskip}
\\
\begin{tabularx}{\linewidth}{|@{~}cc@{~}|@{}>{$}C<{$}@{}|@{}>{$}C<{$}@{}|@{}>{$}C<{$}@{}|}
\hline
\multicolumn{2}{|c|}{\multirow{3}{*}{\text{\thead{Соотношения}}}}  
& \multicolumn{3}{c|}{\text{\thead{Флаги}}} %& \thead{Особенности}
\\\hhline{|~~|-|-|-|}
% &\tikz[baseline]\node[rotate=90] {\theadlong{Отрицательности}};&\tikz[baseline]\node[rotate=90] {\theadlong{Нуля}};&\tikz[baseline]\node[rotate=90] {\theadlong{Несравнимости}};
\multicolumn{2}{|c|}{}  
&\text{\scriptsize{Отрицательности}}&\text{\scriptsize{Нуля}}&\text{\scriptsize{Несравнимости}}
\\
\multicolumn{2}{|c|}{}  
& C0/CF & C3/ZF & C2/PF
\\\hline
$st(0)>src$ & $st(0)-src>0$ & 0 & 0 & 0 \\
$st(0)=src$ & $st(0)-src=0$ & 0 & 1 & 0 \\
$st(0)<src$ & $st(0)-src<0$ & 1 & 0 & 0 \\\hline
\multicolumn{2}{|@{~}c@{~}|}{$st(0)$ и~$src$ несравнимы ($qnan$)}& 1 & 1 & 1
\\\hline
\end{tabularx}
\end{adjustwidth}
\end{frame}


\subsection{Слово состояния и~флаги ЦП}
\colorlet{csControl}{green!50}
\colorlet{csExceptionStatus}{green!7!yellow!7!white}
\colorlet{csSystem}{blue!20!red!10}
\begin{frame}{\insertsubsection}

\setlength{\parskip}{0\parskip}
{
\scriptsize
\renewcommand{\arraystretch}{1.05}
\begin{tabularx}{1\linewidth}{@{}c@{~}|l@{~}|L@{~}|c@{~}|l@{~}|l@{~}}
% № 	& 	&Название 	\\\hline
\multicolumn{3}{c}{$sw$}\\\hhline{---~~~}
\rowcolor{csExceptionStatus}0 	&IE 	& Недействительная операция %(#I)	
&\multicolumn{3}{c}{\cellcolor{white}}\\\hhline{---~~~}
\rowcolor{csExceptionStatus}1 	&DE 	& Денормализованный операнд %(#D)	
&\multicolumn{3}{c}{\cellcolor{white}}\\\hhline{---~~~}
\rowcolor{csExceptionStatus}2 	&ZE 	& Деление на нуль %(#Z)	
&\multicolumn{3}{c}{\cellcolor{white}}\\\hhline{---~~~}
\rowcolor{csExceptionStatus}3 	&ОЕ 	& Переполнение %(#O)	
&\multicolumn{3}{c}{\cellcolor{white}}\\\hhline{---~~~}
\rowcolor{csExceptionStatus}4 	&UE 	& Антипереполнение %(#U)	
&\multicolumn{3}{c}{\cellcolor{white}}\\\hhline{---~~~}
\rowcolor{csExceptionStatus}5 	&РЕ 	& Неточный результат %(#P)	
&\multicolumn{3}{c}{\cellcolor{white}}\\\hhline{---~~~}
\rowcolor{csExceptionStatus}6 	&SF 	& Стековая ошибка	&\multicolumn{3}{c}{\cellcolor{white}}\\\hhline{---~~~}
\rowcolor{csExceptionStatus}7 	&ES 	& Бит суммарной ошибки&\multicolumn{3}{c}{\cellcolor{white}$flags$, fnstsw + sahf} %&&\multirow{-8}{*}{f(n)stsw/sahf}&
\\\hline
\rowcolor{csMarker}8 	&C0 	&&0 	&CF 	&Carry Flag\\\hline
\rowcolor{csMarker}9 	&C1 	&&\multicolumn{3}{c}{{\cellcolor{white}}игнорируется}\\\hline
\rowcolor{csMarker}10 	&C2 	&&2 	&PF 	&Parity Flag\\\hline
\rowcolor{csSystem}11 	& 	&&\multicolumn{3}{c}{{\cellcolor{white}}игнорируется}\\%\hhline{-~~---}
\rowcolor{csSystem}12 	& 	&&\cellcolor{csMarker}4 	&\cellcolor{csMarker}AF 	&\cellcolor{csMarker}Auxiliary Carry Flag\\
\rowcolor{csSystem}13 	&\multirow{-3}{*}{TOP} 	&\multirow{-3}{*}{}&\multicolumn{3}{c}{{\cellcolor{white}}игнорируется}\\\hline
\rowcolor{csMarker}14 	&C3 	& 	&6 	&ZF 	&Zero Flag\\\hline
\rowcolor{csExceptionStatus}15 	&В 	&Дублирует ES	&7 	&SF 	&Sign Flag \\\hline
\end{tabularx}
}
\end{frame}


% \begingroup
% \renewcommand{\tabularxcolumn}[1]{m{#1}}
\subsection{Условная пересылка}
\begin{frame}[fragile]{\insertsubsection}
% \begin{adjustwidth}{-2em}{-2em}

\def\normalsize{\footnotesize}
% \def\normalsize{\scriptsize}
\def\theadfont{\scriptsize\bfseries}
\normalsize
\setlength{\parskip}{0\parskip}

\lstinline!fcmovCC  %st(i), %st(0)! %"--- 

$st(0) = st(i)$ при %некотором условии
некоторой комбинации флагов $flags$


\begin{tabularx}{1\linewidth}{|>{\ttfamily}l|@{}c@{}|%K{7em}|
L|}
% {|K{6em}|X|H|}
\hline
\normalfont\thead{Команда} 
&
% \thead{Условие (флаги)}  
$
\begin{array}{c}
\text{\textbf{\theadfont Условие}}\\[-0.8ex]
\text{\textbf{\theadfont (флаги)}}\\
\end{array}
$
% & %\theadfont Условие (sub src, dst или \mbox{cmp  src, dst})
% % \thead{Условие (sub src, dst или \mbox{cmp  src, dst})}
% % \thead{Условие (арифметика)}
% % &
% \theadfont Условие (\mbox{cmp  src, dst}) 
& \theadfont Условие \mbox{(f[u]comi[p] src, \%st(0))}
\\\hline
fcmove
&	
$ZF = 1$
% &
% %\multicolumn{2}{c|}
% {$dst = src$}
&
$st(0) = src$\\\hline
fcmovne
&	
$ZF = 0$
% &
% $dst \neq src$
&
$st(0) \neq src$
% 
\\\hline
fcmovb/fcmovnae
&	
$CF = 1$
% &
% $dst < src$ как беззнаковое 
&
$st(0) < src$\\\hline
fcmovna/fcmovbe 	
&
$
\left[
\begin{array}{l}
CF = 1\\
ZF = 1
\end{array}
\right.
$
% &
% $dst \leqslant src$ как беззнаковое 
&
$st(0) \leqslant src$\\\hline
fcmovnb/fcmovae
&	
$CF = 0$
% &
% $dst \geqslant src$ как беззнаковое 
&
$st(0) \geqslant src$\\\hline
fcmova/fcmovnbe
&
$
\left\{
\begin{array}{l}
CF = 0\\
ZF = 0
\end{array}
\right.
$
% &
% $dst > src$ как беззнаковое 
&
$st(0) > src$\\\hline
fcmovu
&	
$PF = 1$
&
% Число единиц младшего байта чётно &
$st(0)$ и~$src$ несравнимы
\\\hline
fcmovnu
&	
$PF = 0$
&
% Число единиц младшего байта нечётно &
$st(0)$ и~$src$ сравнимы
\\\hline



\end{tabularx}
% \end{adjustwidth}
\end{frame}
% \endgroup 

\endgroup 

\section{Примеры}


\subsection{Загрузка и~выгрузка из стека}
\begin{frame}[fragile]{\insertsubsection}
\begin{adjustwidth}{-0em}{-2em}
\scriptsize
\begin{lstlisting}[xleftmargin=0mm]
double x = 5.7, y;
int i = 10;
asm(
    "fldl %[SRC]\n" // st(0) = %[SRC]
    "fldz\n"        // st(0) = 0, st(1) = %[SRC]
    "fld1\n"        // st(0) = 1, st(1) = 0, st(2) = %[SRC]
    "fildl %[I]\n"   // st(0) = %[I], st(1) = 1, st(2) = 0, st(3) = %[SRC]
    "fstpl %[DST]\n"// %[DST] = %[I],   st(0) = 1, st(1) = 0, st(2) = %[SRC]
    "fstpl %[DST]\n"// %[DST] = 1,      st(0) = 0, st(1) = %[SRC]
    "fstpl %[DST]\n"// %[DST] = 0,      st(0) = %[SRC]
    "fstpl %[DST]\n"// %[DST] = %[SRC], стек пуст

    :[DST]"=m"(y)
    :[SRC]"m"(x), [I]"m"(i)
    :"cc"
); // y = x и много лишних действий
\end{lstlisting}
\end{adjustwidth}
\end{frame}

\subsection{Арифметические операции}
\begin{frame}[fragile]{\insertsubsection}
\begin{adjustwidth}{-1em}{-2em}
\scriptsize
\begin{lstlisting}[xleftmargin=0mm]
const double a = 0.01;
double x = 5, y;
int i = 10;
asm(
    "fldl %[SRC]\n" // st(0) = %[SRC]
    "fldpi\n"       // st(0) = pi, st(1) = %[SRC]
    "fld1\n"        // st(0) = 1, st(1) = pi, st(2) = %[SRC]
    "fildl %[I]\n"  // st(0) = %[I], st(1) = 1, st(2) = pi, st(3) = %[SRC]
    "fdivrp\n"       // st(0) = 1/%[I], st(1) = pi, st(2) = %[SRC]
    "fldl  %[A]\n"  // st(0) = %[A], st(1) = 1/%[I], st(2) = pi, st(3) = %[SRC]
    "fmulp %%st(0), %%st(2)\n"  // st(0) = 1/%[I], st(1) = pi*%[A], st(2) = %[SRC]
    "faddp\n"       // st(0) = 1/%[I] + pi*%[A], st(1) = %[SRC]
    "faddp\n"       // st(0) = 1/%[I] + pi*%[A] + %[SRC]
    "fstpl %[DST]\n"// %[DST] = 1/%[I] + pi*%[A] + %[SRC], стек пуст

    :[DST]"=m"(y)
    :[SRC]"m"(x), [A]"m"(a), [I]"m"(i)
    :"cc"
);// y = x + 1/i + a*pi
\end{lstlisting}
\end{adjustwidth}
\end{frame}



\subsection{Тригонометрические операции}
\begin{frame}[fragile]{\insertsubsection}
\scriptsize
\begin{lstlisting}[xleftmargin=0mm]
const double a = 100;
double x = M_PI/6, y;
asm(
    "fldl %[SRC]\n" // st(0) = %[SRC]
    "fsincos\n"     // st(0) = cos(%[SRC]), st(1) = sin(%[SRC])
    "fmull %[A]\n"  // st(0) = %[A]*cos(%[SRC]), st(1) = sin(%[SRC])
    "faddp\n"        // st(0) = %[A]*cos(%[SRC]) + sin(%[SRC])
    "fstpl %[DST]\n"// %[DST] = %[A]*cos(%[SRC]) + sin(%[SRC]) стек пуст

    :[DST]"=m"(y)
    :[SRC]"m"(x), [A]"m"(a)
    :"cc"
);	// y = a*cos(x) + sin(x)
\end{lstlisting}
\end{frame}



% *****************************************************************************
\section{}
\begin{frame}{Вопросы}
% \setlength{\leftmargini}{0ex}
% \setlength{\parskip}{0.25\parskip}
\begin{enumerate}

\item Какие регистры используются в~сопроцессоре для хранения операндов?

\item Какие команды используются для выполнения арифметических операций над вещественными числами?

\item Какие команды используются для выполнения тригонометрических операций?

\end{enumerate}

\end{frame}

\makethanks
\end{document}

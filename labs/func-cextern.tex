\section{Импорт внешних функций в~подпрограмму на ассемблере}

Подпрограмма на ассемблере может обращаться не только к~другим подпрограммам из того же модуля на ассемблере, 
но и~к~внешним, в~частности, к~функциям, из других объектных файлов проекта или к~стандартной библиотеке stdlib.

Для того, чтобы функция, описанная на языке C++, была доступна для экспорта в~другие модули, используется ключевое слово extern, как и~для импорта внешних функций (для отключения декорирования также используется \lstinline!extern "C"!):
\begin{lstlisting}
/*@\colorbox{codestronghighlight}{extern "C"{}}@*/
__attribute__((__cdecl__)) 
int /*@\colorbox{codehighlight}{bar}@*/(int x)
{
    return 3*x+1;
};
\end{lstlisting}
% Декорирование C++-функций делает их имена неопознаваемыми, поэтому на практике при экспорте функций лучше использовать только "C" 
% Соглашение о~вызове на всякий случай указано явно с~использованием ключевого слова \lstinline!__attribute__!, но чаще всего для использования cdecl достаточно\lstinline!extern "C"!. 

Для импорта функции в~ассемблере не требуется никаких директив, достаточно знать её имя.
\begin{lstlisting}
pushl $1
call /*@\colorbox{codehighlight}{bar}@*/
addl $4, %esp
\end{lstlisting}
Команда call, в~отличие от оператора вызова функции на ЯВУ, не позволяет передать параметры и~получить возвращаемое значение.
Она только помещает в~стек адрес следующей после вызова подпрограммы команда, а~затем передаёт управление на начало подпрограммы.

Параметры необходимо поместить вручную туда, где их ожидает увидеть подпрограмма.
Для соглашения cdecl они должны находиться в~стеке, куда помещаются командой push в~обратном порядке (приведённый код рассчитывает bar(1)).

После завершения работы такой функции параметры необходимо вручную удалить из стека.
% 
Возвращаемое значение типа int можно найти, в~соответствии с~соглашением о~вызове, в~регистре~\lstinline!%eax!.

% Необходимо всегда помнить о~том, что после вызова функции значения многих регистров меняется.

